<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contador de Aforo Profesional</title>
    <!-- Librería para las gráficas -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Fuentes de Google -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- ESTRUCTURA Y ESTILOS GLOBALES --- */
        :root {
            --font-size-base: 16px;
            --font-family-main: 'Open Sans', sans-serif;
            --font-family-dyslexia: 'Roboto Mono', monospace;
            
            /* Paleta de colores por defecto (Sencillo Claro) */
            --color-primary: #8458B3;
            --color-text: #494D5F;
            --color-bg: #e5eaf5;
            --color-card-bg: #ffffff;
            --color-border: #d0bdf4;
            --color-shadow: rgba(73, 77, 95, 0.15);
            --color-women: #8458B3;
            --color-men: #a0d2eb;
            --color-success: #28a745;
            --color-warning: #ffc107;
            --color-danger: #dc3545;
        }

        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family-main);
            background-color: var(--color-bg);
            color: var(--color-text);
            font-size: var(--font-size-base);
            transition: background-color 0.3s, color 0.3s;
            line-height: 1.6;
        }

        .hidden {
            display: none !important;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
            display: grid;
            gap: 1.5rem;
            grid-template-columns: 1fr;
        }

        .card {
            background-color: var(--color-card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px var(--color-shadow);
            border: 1px solid var(--color-border);
            transition: all 0.3s ease;
        }

        /* --- CABECERA --- */
        header {
            display: flex;
            flex-wrap: wrap; /* Permite el salto de línea en pantallas pequeñas */
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }
        
        header h1 {
            font-size: clamp(1.5rem, 5vw, 2.25rem);
            margin: 0;
            text-align: left;
            flex-grow: 1; 
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .control-btn, select, button {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--color-border);
            background-color: var(--color-card-bg);
            color: var(--color-text);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .control-btn:hover, button:hover, select:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 5px var(--color-shadow);
        }
        
        #role-display {
            font-weight: bold;
            padding: 0.5rem 1rem;
            background-color: var(--color-bg);
            border-radius: 8px;
        }

        /* --- CONTADOR PRINCIPAL --- */
        #main-counter-display {
            font-size: clamp(4rem, 15vw, 8rem);
            font-weight: 700;
            text-align: center;
            padding: 2rem 1rem;
            border-radius: 12px;
            transition: background-color 0.5s, color 0.5s;
            color: white;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        }
        
        .capacity-low { background-color: var(--color-success); }
        .capacity-medium { background-color: var(--color-warning); }
        .capacity-high { background-color: var(--color-danger); }
        .capacity-unlimited { background: linear-gradient(45deg, var(--color-primary), var(--color-women)); }

        #capacity-info {
            text-align: center;
            margin-top: 1rem;
            font-weight: bold;
            font-size: 1.1rem;
        }

        /* --- ENTRADAS DE GÉNERO --- */
        #gender-inputs {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            padding: 1rem;
            border-radius: 8px;
        }
        .women-group { border: 2px solid var(--color-women); }
        .men-group { border: 2px solid var(--color-men); }

        .input-group h3 { margin-bottom: 0.5rem; }
        .input-group input[type="number"] {
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid var(--color-border);
            font-size: 1rem;
            width: 100%;
        }
        .subtract-buttons { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .subtract-buttons button { flex-grow: 1; }
        
        .women-group button { background-color: var(--color-women); color: white; border-color: var(--color-women); }
        .men-group button { background-color: var(--color-men); color: white; border-color: var(--color-men); }
        
        /* --- GRÁFICAS --- */
        .chart-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .chart-header h2 { margin: 0; }
        .chart-controls { display: flex; flex-wrap: wrap; gap: 1rem; }
        .chart-selector { display: flex; align-items: center; gap: 0.5rem; }
        .chart-selector select { padding: 0.5rem; }

        .chart-container {
            position: relative;
            width: 100%;
            min-height: 300px;
        }
        .chart-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }

        /* --- CONTROLES Y AJUSTES --- */
        #controls-section {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .role-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            background-color: var(--color-bg);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .export-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .export-controls select {
            flex-grow: 1;
        }
        
        /* --- MODALES --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: var(--color-card-bg);
            margin: auto;
            padding: 2rem;
            border: 1px solid var(--color-border);
            width: 90%;
            max-width: 500px;
            border-radius: 12px;
            animation: slide-in 0.3s ease-out;
            text-align: center;
        }
        @keyframes slide-in {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .close-btn { font-size: 2rem; cursor: pointer; border: none; background: none; }
        .setting-item { margin-bottom: 1rem; text-align: left; }
        .setting-item label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
        #daily-settings-container {
            border-top: 1px solid var(--color-border);
            margin-top: 1rem;
            padding-top: 1rem;
        }
        #role-selection, .confirm-actions {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
        }
        .confirm-actions {
            flex-direction: row;
            justify-content: center;
        }
        #role-selection button, .confirm-actions button {
            padding: 1rem;
            font-size: 1.2rem;
        }

        /* --- DEFINICIÓN DE TEMAS --- */

        /* MODO OSCURO GENÉRICO (se aplica a todos los temas) */
        body.dark-mode {
            /* Sencillo Oscuro por defecto */
            --color-text: #e5eaf5; --color-bg: #121212; --color-card-bg: #1e1e1e;
            --color-border: #2c2c2c; --color-shadow: rgba(0, 0, 0, 0.3); --color-women: #d0bdf4;
            --color-men: #a0d2eb; --color-primary: #d0bdf4;
        }

        /* TEMA RETRO (Claro) */
        body.theme-retro {
            --color-bg: #fdf6e3; --color-card-bg: #eee8d5; --color-text: #657b83;
            --color-primary: #cb4b16; --color-border: #93a1a1; --color-women: #dc322f;
            --color-men: #268bd2; --color-shadow: rgba(0,0,0,0.1);
        }
        /* TEMA RETRO (Oscuro) */
        body.dark-mode.theme-retro {
            --color-bg: #002b36; --color-card-bg: #073642; --color-text: #839496;
            --color-primary: #cb4b16; --color-border: #586e75; --color-women: #dc322f;
            --color-men: #268bd2; --color-shadow: rgba(0,0,0,0.3);
        }

        /* TEMA ALTO CONTRASTE (Se mantiene igual en ambos modos) */
        body.theme-alto-contraste {
            --color-bg: #000000; --color-card-bg: #000000; --color-text: #ffffff;
            --color-primary: #ffff00; --color-border: #ffff00; --color-women: #ffff00;
            --color-men: #00ffff; --color-shadow: rgba(255,255,0,0.2);
        }

        /* TEMA BOSQUE (Claro) */
        body.theme-bosque {
            --color-bg: #f4f1e9; --color-card-bg: #ffffff; --color-text: #4a4a4a;
            --color-primary: #5a7465; --color-border: #d3c7b3; --color-women: #c7a48b;
            --color-men: #8da382; --color-shadow: rgba(0,0,0,0.1);
        }
        /* TEMA BOSQUE (Oscuro) */
        body.dark-mode.theme-bosque {
            --color-bg: #2d3a32; --color-card-bg: #43584c; --color-text: #e0e0e0;
            --color-primary: #a1b499; --color-border: #5a7465; --color-women: #c7a48b;
            --color-men: #8da382; --color-shadow: rgba(0,0,0,0.3);
        }

        /* TEMA OCEANICO (Claro) */
        body.theme-oceanico {
            --color-bg: #e0f7fa; --color-card-bg: #ffffff; --color-text: #004d40;
            --color-primary: #00796b; --color-border: #b2ebf2; --color-women: #ff8a65;
            --color-men: #4dd0e1; --color-shadow: rgba(0, 121, 107, 0.1);
        }
        /* TEMA OCEANICO (Oscuro) */
        body.dark-mode.theme-oceanico {
            --color-bg: #001f3f; --color-card-bg: #003366; --color-text: #b2ebf2;
            --color-primary: #4dd0e1; --color-border: #004d40; --color-women: #ff8a65;
            --color-men: #4dd0e1; --color-shadow: rgba(0,0,0,0.4);
        }

        /* TEMA RETRO 90s (Claro) */
        body.theme-retro-90s {
            --color-bg: #ffffff; --color-card-bg: #f0f0f0; --color-text: #000000;
            --color-primary: #f400a1; --color-border: #cccccc; --color-women: #be00ff;
            --color-men: #00f0ff; --color-shadow: rgba(0,0,0,0.15);
        }
        /* TEMA RETRO 90s (Oscuro) */
        body.dark-mode.theme-retro-90s {
            --color-bg: #0d0230; --color-card-bg: #231942; --color-text: #ffffff;
            --color-primary: #f400a1; --color-border: #9f1873; --color-women: #be00ff;
            --color-men: #00f0ff; --color-shadow: rgba(190, 0, 255, 0.2);
        }

        /* TEMA MINIMALISTA (Claro) */
        body.theme-minimalista {
            --color-bg: #f5f5f5; --color-card-bg: #ffffff; --color-text: #333333;
            --color-primary: #555555; --color-border: #e0e0e0; --color-women: #777;
            --color-men: #999; --color-shadow: rgba(0,0,0,0.05);
        }
        /* TEMA MINIMALISTA (Oscuro) */
        body.dark-mode.theme-minimalista {
            --color-bg: #121212; --color-card-bg: #1e1e1e; --color-text: #f5f5f5;
            --color-primary: #aaaaaa; --color-border: #333333; --color-women: #bbbbbb;
            --color-men: #999999; --color-shadow: rgba(0,0,0,0.2);
        }

        /* TEMA FUTURISTA (Claro) */
        body.theme-futurista {
            --color-bg: #e1eef5; --color-card-bg: #ffffff; --color-text: #0a192f;
            --color-primary: #0088a3; --color-border: #b0c4de; --color-women: #ff64da;
            --color-men: #64ffda; --color-shadow: rgba(176, 196, 222, 0.4);
        }
        /* TEMA FUTURISTA (Oscuro) */
        body.dark-mode.theme-futurista {
            --color-bg: #0a192f; --color-card-bg: #112240; --color-text: #ccd6f6;
            --color-primary: #64ffda; --color-border: #003358; --color-women: #ff64da;
            --color-men: #64ffda; --color-shadow: rgba(100, 255, 218, 0.2);
        }

        /* Estilo específico para botones de añadir en temas oscuros */
        body.dark-mode .input-group button {
            color: #121212;
            font-weight: 700;
        }
        /* Excepción para Alto Contraste para que el texto siga siendo legible */
        body.dark-mode.theme-alto-contraste .input-group button {
            color: var(--color-bg);
        }


        body.dyslexia-font {
            --font-family-main: var(--font-family-dyslexia);
        }

        /* --- RESPONSIVE DESIGN --- */
        @media (min-width: 768px) {
            .container {
                grid-template-columns: repeat(2, 1fr);
                grid-template-areas:
                    "header header"
                    "counter controls"
                    "inputs inputs"
                    "charts charts";
            }
            header { grid-area: header; }
            #counter-section { grid-area: counter; }
            #controls-section { grid-area: controls; }
            #gender-inputs { grid-area: inputs; grid-template-columns: 1fr 1fr; }
            #charts-section { grid-area: charts; }
            .chart-grid { grid-template-columns: 1fr 1fr; }
        }

        @media (min-width: 1024px) {
            .container {
                grid-template-columns: 1fr 350px;
                grid-template-areas:
                    "header header"
                    "counter controls"
                    "inputs controls"
                    "charts charts";
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <header class="card">
            <h1>Control de Aforo</h1>
            <div class="header-controls">
                <div class="control-item">
                    <label for="theme-select" class="hidden">Tema:</label>
                    <select id="theme-select" title="Seleccionar tema visual">
                        <option value="sencillo">Sencillo</option>
                        <option value="retro">Retro</option>
                        <option value="alto-contraste">Alto Contraste</option>
                        <option value="bosque">Bosque</option>
                        <option value="oceanico">Oceánico</option>
                        <option value="retro-90s">Retro 90s</option>
                        <option value="minimalista">Minimalista</option>
                        <option value="futurista">Futurista</option>
                    </select>
                </div>
                <button id="mode-toggle-btn" class="control-btn" title="Alternar modo claro/oscuro">🌓</button>
                <button id="screen-reader-btn" class="control-btn" aria-label="Activar lector de pantalla">🔊</button>
            </div>
        </header>

        <section id="counter-section" class="card">
            <div id="main-counter-display" class="capacity-unlimited">0</div>
            <div id="capacity-info">
                Modo: <strong id="mode-label">Sin Límite</strong> | Aforo Máximo: <strong id="capacity-label">∞</strong>
            </div>
        </section>

        <section id="gender-inputs" class="card">
            <div class="input-group women-group">
                <h3>Mujeres: <span id="women-count">0</span></h3>
                <input type="number" id="women-input" placeholder="Añadir cantidad" min="1">
                <button id="add-women-btn">Añadir</button>
                <div id="women-subtract-buttons" class="subtract-buttons"></div>
            </div>
            <div class="input-group men-group">
                <h3>Hombres: <span id="men-count">0</span></h3>
                <input type="number" id="men-input" placeholder="Añadir cantidad" min="1">
                <button id="add-men-btn">Añadir</button>
                <div id="men-subtract-buttons" class="subtract-buttons"></div>
            </div>
        </section>

        <section id="charts-section" class="card">
            <div class="chart-header">
                <h2>Analíticas de Aforo</h2>
                <div class="chart-controls">
                    <div class="chart-selector">
                        <label for="gender-chart-type">Gráfico Género:</label>
                        <select id="gender-chart-type">
                            <option value="bar">Barras</option>
                            <option value="pie">Circular</option>
                            <option value="doughnut">Anillo</option>
                            <option value="radar">Radar</option>
                        </select>
                    </div>
                    <div class="chart-selector">
                        <label for="hourly-chart-type">Gráfico Horario:</label>
                        <select id="hourly-chart-type">
                            <option value="line">Línea</option>
                            <option value="bar">Barras</option>
                            <option value="radar">Radar</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="chart-grid">
                <div class="chart-container">
                    <canvas id="gender-chart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="hourly-chart"></canvas>
                </div>
            </div>
        </section>

        <aside id="controls-section" class="card">
            <h3>Controles y Exportación</h3>
            <div class="role-controls">
                <span id="role-display"></span>
                <button id="change-role-btn">Cambiar Rol</button>
            </div>
            <button id="save-data-btn">Guardar</button>
            <button id="reset-day-btn">Resetear Día</button>
            <div class="export-controls">
                <select id="export-format-select">
                    <option value="csv">Exportar CSV (Informe)</option>
                    <option value="json">Exportar JSON (Base de Datos)</option>
                </select>
                <button id="export-data-btn">Exportar</button>
            </div>
            <button id="import-data-btn">Importar JSON (Base de Datos)</button>
            <input type="file" id="import-file-input" class="hidden" accept=".json">
            <button id="settings-btn">Ajustes</button>
        </aside>

    </div>

    <!-- Modal de Ajustes -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ajustes</h2>
                <span id="close-settings-modal-btn" class="close-btn">&times;</span>
            </div>
            <div class="setting-item">
                <label for="capacity-mode">Modo de Aforo</label>
                <select id="capacity-mode">
                    <option value="unlimited">Sin Límite</option>
                    <option value="daily">Por Días</option>
                </select>
            </div>
            <div id="daily-settings-container" class="setting-item hidden">
                <label for="day-override-select">Forzar Día y Aforo</label>
                <select id="day-override-select">
                    <option value="auto">Automático (Hoy)</option>
                    <option value="1">Lunes</option>
                    <option value="2">Martes</option>
                    <option value="3">Miércoles</option>
                    <option value="4">Jueves</option>
                    <option value="5">Viernes</option>
                    <option value="6">Sábado</option>
                    <option value="0">Domingo</option>
                </select>
                <input type="number" id="capacity-override-input" placeholder="Aforo personalizado" min="0" style="margin-top: 0.5rem; width: 100%;">
            </div>
            <div class="setting-item">
                <label for="font-size-slider">Tamaño de Letra</label>
                <input type="range" id="font-size-slider" min="12" max="24" step="1">
            </div>
            <div class="setting-item">
                <label for="dyslexia-toggle">Fuente para Dislexia</label>
                <input type="checkbox" id="dyslexia-toggle">
            </div>
        </div>
    </div>
    
    <!-- Modal de Roles -->
    <div id="role-modal" class="modal">
        <div class="modal-content">
            <h2>Selecciona tu Rol</h2>
            <div id="role-selection">
                <button data-role="portero">Portero</button>
                <button data-role="director">Director</button>
                <button data-role="dueño">Dueño</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <h2 id="confirm-title">¿Estás seguro?</h2>
            <p id="confirm-message">Esta acción no se puede deshacer.</p>
            <div class="confirm-actions">
                <button id="confirm-yes-btn">Sí</button>
                <button id="confirm-no-btn">No</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Notificación -->
    <div id="notification-modal" class="modal">
        <div class="modal-content">
            <h2 id="notification-title">Notificación</h2>
            <p id="notification-message">Este es un mensaje de notificación.</p>
            <div class="confirm-actions">
                <button id="notification-ok-btn">Aceptar</button>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. ESTADO DE LA APLICACIÓN Y REFERENCIAS AL DOM ---
        let state = {}; // Se inicializará con getNewState

        const getNewState = () => ({
            womenCount: 0,
            menCount: 0,
            get totalCount() { return this.womenCount + this.menCount; },
            records: [],
            settings: {
                userRole: null,
                theme: 'sencillo',
                isDarkMode: false,
                capacityMode: 'unlimited',
                fontSize: 16,
                dyslexiaFont: false,
                dayOverride: 'auto',
                capacityOverride: null,
                genderChartType: 'bar',
                hourlyChartType: 'line',
            }
        });

        state = getNewState();

        const dom = {
            body: document.body,
            container: document.querySelector('.container'),
            mainCounter: document.getElementById('main-counter-display'),
            capacityInfo: {
                mode: document.getElementById('mode-label'),
                capacity: document.getElementById('capacity-label')
            },
            women: {
                count: document.getElementById('women-count'),
                input: document.getElementById('women-input'),
                addBtn: document.getElementById('add-women-btn'),
                subtractContainer: document.getElementById('women-subtract-buttons')
            },
            men: {
                count: document.getElementById('men-count'),
                input: document.getElementById('men-input'),
                addBtn: document.getElementById('add-men-btn'),
                subtractContainer: document.getElementById('men-subtract-buttons')
            },
            theme: {
                select: document.getElementById('theme-select'),
                modeToggleBtn: document.getElementById('mode-toggle-btn'),
            },
            charts: {
                section: document.getElementById('charts-section'),
                gender: null,
                hourly: null,
                genderTypeSelect: document.getElementById('gender-chart-type'),
                hourlyTypeSelect: document.getElementById('hourly-chart-type'),
            },
            settings: {
                modal: document.getElementById('settings-modal'),
                openBtn: document.getElementById('settings-btn'),
                closeBtn: document.getElementById('close-settings-modal-btn'),
                capacityMode: document.getElementById('capacity-mode'),
                fontSizeSlider: document.getElementById('font-size-slider'),
                dyslexiaToggle: document.getElementById('dyslexia-toggle'),
                dailySettingsContainer: document.getElementById('daily-settings-container'),
                dayOverrideSelect: document.getElementById('day-override-select'),
                capacityOverrideInput: document.getElementById('capacity-override-input'),
            },
            controls: {
                section: document.getElementById('controls-section'),
                saveData: document.getElementById('save-data-btn'),
                resetDay: document.getElementById('reset-day-btn'),
                exportBtn: document.getElementById('export-data-btn'),
                exportFormat: document.getElementById('export-format-select'),
                importBtn: document.getElementById('import-data-btn'),
                importInput: document.getElementById('import-file-input'),
                screenReader: document.getElementById('screen-reader-btn')
            },
            roles: {
                modal: document.getElementById('role-modal'),
                selectionContainer: document.getElementById('role-selection'),
                display: document.getElementById('role-display'),
                changeBtn: document.getElementById('change-role-btn')
            },
            confirm: {
                modal: document.getElementById('confirm-modal'),
                title: document.getElementById('confirm-title'),
                message: document.getElementById('confirm-message'),
                yesBtn: document.getElementById('confirm-yes-btn'),
                noBtn: document.getElementById('confirm-no-btn'),
            },
            notification: {
                modal: document.getElementById('notification-modal'),
                title: document.getElementById('notification-title'),
                message: document.getElementById('notification-message'),
                okBtn: document.getElementById('notification-ok-btn'),
            }
        };

        let screenReaderActive = false;

        // --- 2. LÓGICA DE ROLES Y PERSISTENCIA POR ROL ---

        const applyRolePermissions = () => {
            const role = state.settings.userRole;
            if (!role) {
                dom.roles.modal.style.display = 'flex';
                dom.container.classList.add('hidden');
                return;
            }
            
            dom.roles.modal.style.display = 'none';
            dom.container.classList.remove('hidden');
            dom.roles.display.textContent = `Rol: ${role.charAt(0).toUpperCase() + role.slice(1)}`;

            const isPortero = role === 'portero';
            const isDueño = role === 'dueño';

            dom.charts.section.classList.toggle('hidden', isPortero);
            dom.settings.openBtn.classList.toggle('hidden', !isDueño);
            dom.controls.importBtn.classList.toggle('hidden', !isDueño);
            dom.controls.exportFormat.parentElement.classList.toggle('hidden', isPortero);
        };
        
        const setRole = (role) => {
            // Antes de cambiar, guarda el estado actual (especialmente los ajustes del rol anterior)
            if (state.settings.userRole) {
                saveData(true);
            }
            
            const allData = JSON.parse(localStorage.getItem('personCounterSharedData')) || {
                sharedData: { womenCount: 0, menCount: 0, records: [] },
                rolesSettings: {}
            };

            // 1. Carga los datos compartidos en el estado
            state.womenCount = allData.sharedData.womenCount || 0;
            state.menCount = allData.sharedData.menCount || 0;
            state.records = allData.sharedData.records || [];

            // 2. Carga los ajustes para el nuevo rol, o usa los predeterminados
            const defaultSettings = getNewState().settings;
            const roleSettings = allData.rolesSettings[role] || {};
            state.settings = { ...defaultSettings, ...roleSettings };
            state.settings.userRole = role;

            // 3. Guarda el último rol y renderiza todo
            localStorage.setItem('personCounterLastRole', role);
            renderAll();
        };

        // --- 3. LÓGICA DEL CONTADOR Y CAPACIDAD ---
        
        const getDailyCapacity = () => {
            if (state.settings.capacityMode !== 'daily') return Infinity;
            
            if (state.settings.capacityOverride !== null && !isNaN(state.settings.capacityOverride)) {
                return state.settings.capacityOverride;
            }

            const dayToEvaluate = state.settings.dayOverride === 'auto' 
                ? new Date().getDay() 
                : parseInt(state.settings.dayOverride);

            if (dayToEvaluate >= 1 && dayToEvaluate <= 4) return 500;
            return 1500;
        };

        const updateCounterDisplay = () => {
            dom.mainCounter.textContent = state.totalCount;
            dom.women.count.textContent = state.womenCount;
            dom.men.count.textContent = state.menCount;

            const capacity = getDailyCapacity();
            const percentage = capacity === Infinity ? 0 : (state.totalCount / capacity) * 100;
            
            dom.mainCounter.className = 'main-counter-display';

            if (capacity === Infinity) {
                dom.mainCounter.classList.add('capacity-unlimited');
            } else if (percentage < 50) {
                dom.mainCounter.classList.add('capacity-low');
            } else if (percentage < 90) {
                dom.mainCounter.classList.add('capacity-medium');
            } else {
                dom.mainCounter.classList.add('capacity-high');
            }

            dom.capacityInfo.mode.textContent = state.settings.capacityMode === 'daily' ? 'Por Días' : 'Sin Límite';
            dom.capacityInfo.capacity.textContent = capacity === Infinity ? '∞' : capacity;
        };

        const addRecord = (gender, count, type) => {
            state.records.push({ 
                timestamp: new Date().toISOString(), 
                gender, 
                count, 
                type,
                womenCountAfter: state.womenCount,
                menCountAfter: state.menCount
            });
        };
        
        const addPeople = (gender, count) => {
            const capacity = getDailyCapacity();
            if (state.totalCount + count > capacity) {
                showNotification('Aforo Superado', `No se pueden añadir ${count} personas, el aforo máximo de ${capacity} sería superado.`);
                return;
            }
            if (gender === 'women') state.womenCount += count;
            if (gender === 'men') state.menCount += count;
            addRecord(gender, count, 'add');
            renderAll();
        };

        const subtractPeople = (gender, count) => {
            if (gender === 'women' && state.womenCount >= count) {
                state.womenCount -= count;
            } else if (gender === 'men' && state.menCount >= count) {
                state.menCount -= count;
            } else {
                return;
            }
            addRecord(gender, count, 'subtract');
            renderAll();
        };

        // --- 4. MANEJO DE LA INTERFAZ Y BOTONES ---

        const createSubtractButtons = (gender, container) => {
            container.innerHTML = '';
            const count = gender === 'women' ? state.womenCount : state.menCount;
            if (count > 0) {
                [1, 10, 100].forEach(val => {
                    if (count >= val) {
                        const btn = document.createElement('button');
                        btn.textContent = `- ${val}`;
                        btn.onclick = () => subtractPeople(gender, val);
                        container.appendChild(btn);
                    }
                });
            }
        };

        // --- 5. GRÁFICAS (CHART.JS) ---

        const updateCharts = () => {
            if (state.settings.userRole === 'portero') return;

            // Retraso ligero para permitir que las variables CSS se apliquen
            setTimeout(() => {
                const computedStyles = getComputedStyle(dom.body);
                const womenColor = computedStyles.getPropertyValue('--color-women').trim();
                const menColor = computedStyles.getPropertyValue('--color-men').trim();
                const successColor = computedStyles.getPropertyValue('--color-success').trim();
                const dangerColor = computedStyles.getPropertyValue('--color-danger').trim();
                const borderColor = computedStyles.getPropertyValue('--color-border').trim();

                if (dom.charts.gender) dom.charts.gender.destroy();
                const genderCtx = document.getElementById('gender-chart').getContext('2d');
                dom.charts.gender = new Chart(genderCtx, {
                    type: state.settings.genderChartType,
                    data: {
                        labels: ['Mujeres', 'Hombres'],
                        datasets: [{
                            data: [state.womenCount, state.menCount],
                            backgroundColor: [womenColor, menColor],
                            borderColor: borderColor, borderWidth: 1
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });

                if (dom.charts.hourly) dom.charts.hourly.destroy();
                const hourlyCtx = document.getElementById('hourly-chart').getContext('2d');
                const hourlyAdds = Array(24).fill(0);
                const hourlySubs = Array(24).fill(0);
                state.records.forEach(rec => {
                    const hour = new Date(rec.timestamp).getHours();
                    if (rec.type === 'add') hourlyAdds[hour] += rec.count;
                    else hourlySubs[hour] += rec.count;
                });
                dom.charts.hourly = new Chart(hourlyCtx, {
                    type: state.settings.hourlyChartType,
                    data: {
                        labels: Array.from({ length: 24 }, (_, i) => `${i}:00`),
                        datasets: [
                            { label: 'Entradas', data: hourlyAdds, borderColor: successColor, backgroundColor: successColor + '80', tension: 0.1 },
                            { label: 'Salidas', data: hourlySubs, borderColor: dangerColor, backgroundColor: dangerColor + '80', tension: 0.1 }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }, 50);
        };

        // --- 6. TEMAS Y AJUSTES ---

        const applyTheme = () => {
            dom.body.className = ''; // Limpiamos todas las clases
            dom.body.classList.add(`theme-${state.settings.theme}`);
            if (state.settings.isDarkMode) {
                dom.body.classList.add('dark-mode');
            }
            if (state.settings.dyslexiaFont) {
                dom.body.classList.add('dyslexia-font');
            }
            document.documentElement.style.setProperty('--font-size-base', `${state.settings.fontSize}px`);
            dom.theme.modeToggleBtn.textContent = state.settings.isDarkMode ? '☀️' : '🌓';
        };
        
        const renderSettings = () => {
            dom.settings.dailySettingsContainer.classList.toggle('hidden', state.settings.capacityMode !== 'daily');
            dom.settings.capacityMode.value = state.settings.capacityMode;
            dom.settings.fontSizeSlider.value = state.settings.fontSize;
            dom.settings.dyslexiaToggle.checked = state.settings.dyslexiaFont;
            dom.settings.dayOverrideSelect.value = state.settings.dayOverride;
            dom.settings.capacityOverrideInput.value = state.settings.capacityOverride ?? '';
            dom.charts.genderTypeSelect.value = state.settings.genderChartType;
            dom.charts.hourlyTypeSelect.value = state.settings.hourlyChartType;
            dom.theme.select.value = state.settings.theme;
        };

        // --- 7. MODALES, IMPORT/EXPORT Y PERSISTENCIA ---
        
        const showNotification = (title, message) => {
            dom.notification.title.textContent = title;
            dom.notification.message.textContent = message;
            dom.notification.modal.style.display = 'flex';
        };

        const saveData = (silent = false) => {
            if (!state.settings.userRole) return;
            const allData = JSON.parse(localStorage.getItem('personCounterSharedData')) || {
                sharedData: { womenCount: 0, menCount: 0, records: [] },
                rolesSettings: {}
            };

            // 1. Actualiza la parte de datos compartidos desde el estado actual
            allData.sharedData.womenCount = state.womenCount;
            allData.sharedData.menCount = state.menCount;
            allData.sharedData.records = state.records;

            // 2. Actualiza los ajustes para el rol actual
            allData.rolesSettings[state.settings.userRole] = state.settings;

            // 3. Guarda todo de nuevo
            localStorage.setItem('personCounterSharedData', JSON.stringify(allData));

            if (!silent) showNotification('Guardado', '¡Datos guardados correctamente!');
        };
        
        const loadInitialRole = () => {
            const lastRole = localStorage.getItem('personCounterLastRole');
            if (lastRole) {
                setRole(lastRole);
            } else {
                renderAll();
            }
        };

        const showConfirm = (title, message, onConfirm) => {
            dom.confirm.title.textContent = title;
            dom.confirm.message.textContent = message;
            dom.confirm.modal.style.display = 'flex';
            
            dom.confirm.yesBtn.onclick = () => {
                dom.confirm.modal.style.display = 'none';
                onConfirm();
            };
            dom.confirm.noBtn.onclick = () => {
                dom.confirm.modal.style.display = 'none';
            };
        };

        const importData = (file) => {
            if (!file || file.type !== 'application/json') {
                showNotification('Error', 'Por favor, selecciona un archivo JSON válido.');
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    // Comprueba si tiene el nuevo formato compartido
                    if (importedData.sharedData && importedData.rolesSettings) {
                         showConfirm('Importar Base de Datos', '¿Seguro que quieres sobreescribir TODOS los datos compartidos y de roles?', () => {
                            localStorage.setItem('personCounterSharedData', JSON.stringify(importedData));
                            const currentRole = state.settings.userRole || localStorage.getItem('personCounterLastRole');
                            if (currentRole) {
                                setRole(currentRole); // Recarga la UI con los nuevos datos
                            } else {
                                renderAll(); // Muestra la selección de rol si no había ninguno activo
                            }
                            showNotification('Éxito', '¡Datos importados correctamente!');
                        });
                    } else {
                        showNotification('Error de Formato', 'El archivo de importación no es compatible. Debe ser un archivo de datos compartidos.');
                    }
                } catch (error) {
                    showNotification('Error de Importación', 'Error al leer el archivo. Asegúrate de que es un archivo JSON válido.');
                }
            };
            reader.readAsText(file);
        };

        const exportData = () => {
            const format = dom.controls.exportFormat.value;
            const date = new Date().toISOString().split('T')[0];
            let fileContent, mimeType, fileName;

            if (format === 'json') {
                const allData = localStorage.getItem('personCounterSharedData') || '{}';
                fileContent = JSON.stringify(JSON.parse(allData), null, 2);
                mimeType = 'application/json';
                fileName = `aforo_backup_total_compartido_${date}.json`;
            } else { // CSV
                if (state.records.length === 0) {
                    showNotification('Exportación Vacía', 'No hay registros para exportar en el informe.');
                    return;
                }
                const headers = "Timestamp,Hora,Tipo,Genero,Cantidad,Mujeres Despues,Hombres Despues,Total Despues,Aforo Max\n";
                const capacityToday = getDailyCapacity();
                const rows = state.records.map(rec => {
                    const d = new Date(rec.timestamp);
                    const time = d.toTimeString().split(' ')[0];
                    const type = rec.type === 'add' ? 'Entrada' : 'Salida';
                    const gender = rec.gender === 'women' ? 'Mujer' : 'Hombre';
                    return [rec.timestamp, time, type, gender, rec.count, rec.womenCountAfter, rec.menCountAfter,
                        rec.womenCountAfter + rec.menCountAfter, capacityToday === Infinity ? 'Ilimitado' : capacityToday].join(',');
                }).join('\n');
                fileContent = headers + rows;
                mimeType = 'text/csv';
                fileName = `aforo_informe_compartido_${date}.csv`;
            }

            const blob = new Blob([fileContent], { type: `${mimeType};charset=utf-8,` });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // --- 8. ACCESIBILIDAD ---
        const speak = (text) => {
            if (!screenReaderActive || !window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'es-ES';
            window.speechSynthesis.speak(utterance);
        };
        
        // --- 9. INICIALIZACIÓN Y EVENT LISTENERS ---
        const renderAll = () => {
            applyRolePermissions();
            if (state.settings.userRole) {
                applyTheme();
                renderSettings();
                updateCounterDisplay();
                createSubtractButtons('women', dom.women.subtractContainer);
                createSubtractButtons('men', dom.men.subtractContainer);
                updateCharts();
            }
        };

        const init = () => {
            dom.women.addBtn.onclick = () => {
                const val = parseInt(dom.women.input.value);
                if (val > 0) addPeople('women', val);
                dom.women.input.value = '';
            };
            dom.men.addBtn.onclick = () => {
                const val = parseInt(dom.men.input.value);
                if (val > 0) addPeople('men', val);
                dom.men.input.value = '';
            };

            dom.theme.modeToggleBtn.onclick = () => {
                state.settings.isDarkMode = !state.settings.isDarkMode;
                applyTheme();
                updateCharts();
                saveData(true);
            };

            dom.theme.select.onchange = (e) => {
                state.settings.theme = e.target.value;
                applyTheme();
                updateCharts();
                saveData(true);
            };
            
            dom.charts.genderTypeSelect.onchange = (e) => { state.settings.genderChartType = e.target.value; renderAll(); };
            dom.charts.hourlyTypeSelect.onchange = (e) => { state.settings.hourlyChartType = e.target.value; renderAll(); };

            dom.controls.saveData.onclick = () => saveData(false);
            dom.controls.resetDay.onclick = () => {
                showConfirm('Resetear Día', '¿Seguro que quieres borrar todos los datos del día? Esta acción afectará a TODOS los roles.', () => {
                    // Resetea las partes compartidas del estado
                    state.womenCount = 0;
                    state.menCount = 0;
                    state.records = [];
                    // Renderiza la UI inmediatamente
                    renderAll();
                    // Guarda el estado reseteado silenciosamente
                    saveData(true);
                });
            };
            dom.controls.exportBtn.onclick = exportData;
            dom.controls.importBtn.onclick = () => dom.controls.importInput.click();
            dom.controls.importInput.onchange = (e) => { importData(e.target.files[0]); e.target.value = null; };

            dom.settings.openBtn.onclick = () => dom.settings.modal.style.display = 'flex';
            dom.settings.closeBtn.onclick = () => { dom.settings.modal.style.display = 'none'; saveData(true); };
            
            dom.settings.capacityMode.onchange = (e) => { state.settings.capacityMode = e.target.value; renderAll(); };
            dom.settings.dayOverrideSelect.onchange = (e) => { state.settings.dayOverride = e.target.value; renderAll(); };
            dom.settings.capacityOverrideInput.oninput = (e) => { state.settings.capacityOverride = e.target.value === '' ? null : parseInt(e.target.value); renderAll();};
            dom.settings.fontSizeSlider.oninput = (e) => { state.settings.fontSize = e.target.value; applyTheme(); };
            dom.settings.dyslexiaToggle.onchange = (e) => { state.settings.dyslexiaFont = e.target.checked; renderAll(); };

            dom.roles.selectionContainer.onclick = (e) => {
                if(e.target.tagName === 'BUTTON') {
                    setRole(e.target.dataset.role);
                }
            };
            dom.roles.changeBtn.onclick = () => {
                showConfirm('Cambiar de Rol', '¿Seguro que quieres cambiar de rol? Se guardarán los datos actuales.', () => {
                    saveData(true);
                    state = getNewState(); // Reset state before showing role modal
                    renderAll();
                });
            };

            dom.controls.screenReader.onclick = () => {
                screenReaderActive = !screenReaderActive;
                dom.controls.screenReader.style.backgroundColor = screenReaderActive ? 'var(--color-success)' : '';
                const message = screenReaderActive ? 'Lector de pantalla activado' : 'Lector de pantalla desactivado';
                showNotification('Accesibilidad', message);
                speak(message);
            };
            
            dom.notification.okBtn.onclick = () => { dom.notification.modal.style.display = 'none'; };
            
            document.querySelectorAll('button, a, input, select').forEach(el => {
                el.addEventListener('focus', () => speak(el.title || el.innerText || el.ariaLabel || 'Elemento interactivo'));
            });
            
            loadInitialRole();
        };

        init();
    });
    </script>

</body>
</html>






