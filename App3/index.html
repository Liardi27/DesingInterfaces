<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario Musical</title>
    <!-- Tailwind CSS para un dise√±o moderno y responsivo --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts para una tipograf√≠a m√°s agradable --><link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Poppins:wght@400;600;700&family=Merriweather:wght@400;700&family=Montserrat:wght@400;600;700&family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- --- INICIO DE LA MODIFICACI√ìN: METAS PARA PWA (Multiplataforma) --- -->
    <meta name="theme-color" content="#111827">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Diario Musical">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/FBBF24/111827?text=üéµ">
    <link rel="manifest" href="data:application/json;charset=utf-8,%7B%22name%22%3A%22Diario%20Musical%22%2C%22short_name%22%3A%22Diario%22%2C%22description%22%3A%22Tu%20calendario%20musical%20personal.%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23111827%22%2C%22theme_color%22%3A%22%23111827%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22https%3A%2F%2Fplacehold.co%2F192x192%2FFBBF24%2F111827%3Ftext%3D%F0%9F%8E%B5%22%2C%22sizes%22%3A%22192x192%22%2C%22type%22%3A%22image%2Fpng%22%7D%2C%7B%22src%22%3A%22https%3A%2F%2Fplacehold.co%2F512x512%2FFBBF24%2F111827%3Ftext%3D%F0%9F%8E%B5%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fpng%22%7D%5D%7D">
    <!-- --- FIN DE LA MODIFICACI√ìN --- -->

    <style>
        :root {
            --font-main: 'Inter', sans-serif;
            --bg-primary: #111827; /* bg-gray-900 */
            --bg-secondary: #1f2937; /* bg-gray-800 */
            --bg-tertiary: #374151; /* bg-gray-700 */
            --bg-padding: #0f172a; /* bg-slate-900 */
            --text-primary: #F9FAFB; /* text-gray-100 */
            --text-secondary: #9ca3af; /* text-gray-400 */
            --accent-primary: #FBBF24; /* amber-400 */
            --accent-primary-hover: #F59E0B; /* amber-500 */
            --day-selected: #1D4ED8; /* blue-700 */
            --day-current-border: #FBBF24; /* amber-400 */
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        .themed-bg-secondary { background-color: var(--bg-secondary); }
        .themed-bg-tertiary { background-color: var(--bg-tertiary); }
        .themed-bg-padding { background-color: var(--bg-padding); }
        .themed-text-primary { color: var(--text-primary); }
        .themed-text-secondary { color: var(--text-secondary); }
        .themed-text-accent { color: var(--accent-primary); }
        .themed-accent-button { background-color: var(--accent-primary); }
        .themed-accent-button:hover { background-color: var(--accent-primary-hover); }
        .themed-ring-focus:focus { ring-color: var(--accent-primary); }

        .current-day {
            background-color: var(--bg-tertiary);
            border: 2px solid var(--day-current-border);
        }
        .selected-day {
            background-color: var(--day-selected);
            color: white;
            transform: scale(1.05);
            box-shadow: 0 0 15px var(--day-selected);
            transition: all 0.2s ease-in-out;
        }
        .calendar-day:hover {
            background-color: var(--bg-tertiary);
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(100%); } to { opacity: 1; transform: translateY(0); } }

        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .zoom-in { animation: zoomIn 0.3s ease-out forwards; }
        .slide-in-up { animation: slideInUp 0.5s ease-out forwards; }

        button:disabled { opacity: 0.7; cursor: not-allowed; }
        #close-stats-modal svg, #close-day-modal svg, #close-achievements-modal svg, #close-wardrobe-modal svg { pointer-events: none; }
        .speed-control-btn.active {
            background-color: var(--accent-primary);
            color: #111827;
        }

        /* Ajustes de tama√±o de fuente espec√≠ficos para el tema retro */
        .theme-retro h1, .theme-retro #special-theme-banner { font-size: 1rem; line-height: 1.25rem; }
        .theme-retro #monthDisplay { font-size: 0.875rem; }
        .theme-retro main .font-semibold > div { font-size: 0.75rem; }
        .theme-retro .calendar-day { font-size: 0.875rem; }
        .theme-retro #day-modal-content h2 { font-size: 0.875rem; }
        .theme-retro #song-title { font-size: 1rem; line-height: 1.4rem; }
        .theme-retro #note-textarea, .theme-retro select { font-size: 0.75rem; }
        .theme-retro button { font-size: 0.75rem; }
        
        /* --- NUEVA ANIMACI√ìN PARA LETRAS --- */
        @keyframes subtleBob {
            0%, 80%, 100% {
                transform: translateY(0) scale(1);
                color: var(--text-primary);
            }
            90% {
                transform: translateY(-5px) scale(1.1);
                color: var(--accent-primary);
            }
        }

        #monthDisplay .animated-letter {
            display: inline-block;
            animation: subtleBob 4s infinite ease-in-out;
            transition: color 0.3s;
        }

         /* Retraso escalonado para el efecto "ola" */
         #monthDisplay .animated-letter:nth-child(1) { animation-delay: 0.1s; }
         #monthDisplay .animated-letter:nth-child(2) { animation-delay: 0.2s; }
         #monthDisplay .animated-letter:nth-child(3) { animation-delay: 0.3s; }
         #monthDisplay .animated-letter:nth-child(4) { animation-delay: 0.4s; }
         #monthDisplay .animated-letter:nth-child(5) { animation-delay: 0.5s; }
         #monthDisplay .animated-letter:nth-child(6) { animation-delay: 0.6s; }
         #monthDisplay .animated-letter:nth-child(7) { animation-delay: 0.7s; }
         #monthDisplay .animated-letter:nth-child(8) { animation-delay: 0.8s; }
         #monthDisplay .animated-letter:nth-child(9) { animation-delay: 0.9s; }
         #monthDisplay .animated-letter:nth-child(10) { animation-delay: 1.0s; }
         /* --- FIN DE ANIMACI√ìN --- */
        
        /* Estilos para los objetos del monigote */
        .item-card {
            border: 2px solid transparent;
            cursor: pointer;
        }
        .item-card.selected {
            border-color: var(--accent-primary);
            box-shadow: 0 0 10px var(--accent-primary);
        }
        .item-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        /* --- ESTILO PARA INDICADOR DE NOTA --- */
        .note-indicator {
            position: absolute;
            bottom: 4px;
            right: 4px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--accent-primary);
            box-shadow: 0 0 3px rgba(0,0,0,0.5);
        }
        /* Ajustar posici√≥n relativa para que el indicador se posicione correctamente */
        .calendar-day {
            position: relative;
        }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">

    <div class="max-w-7xl mx-auto flex flex-col gap-6">
        <!-- Banner de Mes Tem√°tico --><div id="special-theme-banner" class="hidden text-center p-3 themed-bg-secondary rounded-lg font-bold themed-text-accent shadow-lg"></div>

        <!-- Cabecera --><header class="flex flex-col sm:flex-row justify-between items-center p-4 themed-bg-secondary rounded-lg shadow-lg fade-in gap-4">
            <h1 class="text-xl sm:text-2xl font-bold themed-text-accent text-center sm:text-left">Mi Diario Musical</h1>
            <div class="flex items-center gap-4">
                <div id="monthDisplay" class="text-lg sm:text-xl font-semibold flex items-center"></div>
                <div class="flex gap-2">
                    <button id="backButton" class="p-2 rounded-full hover:themed-bg-tertiary transition-colors"><i class="fa-solid fa-caret-left fa-lg"></i></button>
                    <button id="nextButton" class="p-2 rounded-full hover:themed-bg-tertiary transition-colors"><i class="fa-solid fa-caret-right fa-lg"></i></button>
                </div>
            </div>
             <!-- Funciones Adicionales -->
            <div class="flex flex-wrap items-center justify-center gap-3">
                <select id="theme-switcher" title="Cambiar tema"
                    class="w-full sm:w-auto themed-bg-tertiary border border-gray-600 themed-text-primary text-sm rounded-lg focus:ring-2 focus:ring-amber-400 p-2.5 transition">
                    <option value="basico">B√°sico</option>
                    <option value="oceanico">Oce√°nico</option>
                    <option value="bosque">Bosque</option>
                    <option value="playa">Playa</option>
                    <option value="retro">Retro</option>
                </select>
                
                <!-- Playlist -->
                <button id="playlist-button" title="Reproducir Playlist del Mes"
                    class="p-2.5 rounded-full themed-bg-tertiary hover:scale-110 hover:themed-bg-padding transition-all duration-200">
                    <i class="fa-solid fa-list fa-lg themed-text-accent"></i>
                </button>

                <!-- Estad√≠sticas -->
                <button id="stats-button" title="Ver Estad√≠sticas"
                    class="p-2.5 rounded-full themed-bg-tertiary hover:scale-110 hover:themed-bg-padding transition-all duration-200">
                    <i class="fa-solid fa-chart-bar fa-lg themed-text-accent"></i>
                </button>

                <!-- Logros -->
                <button id="achievements-button" title="Ver Logros"
                    class="p-2.5 rounded-full themed-bg-tertiary hover:scale-110 hover:themed-bg-padding transition-all duration-200 relative">
                    <i class="fa-solid fa-medal fa-lg themed-text-accent"></i>
                    <span id="achievements-badge"
                        class="hidden absolute -top-1 -right-1 bg-amber-400 text-gray-900 text-xs font-bold rounded-full w-4 h-4 flex items-center justify-center">!</span>
                </button>

                <!-- Vestuario -->
                <button id="wardrobe-button" title="Personalizar Monigote"
                    class="p-2.5 rounded-full themed-bg-tertiary hover:scale-110 hover:themed-bg-padding transition-all duration-200">
                    <i class="fa-solid fa-shirt fa-lg themed-text-accent"></i>
                </button>
            </div>
        </header>

        <!-- Calendario --><main class="themed-bg-secondary p-4 rounded-lg shadow-lg fade-in" style="animation-delay: 0.1s;">
            <div class="grid grid-cols-7 gap-2 text-center font-semibold mb-2 themed-text-accent">
                <div>Lun</div><div>Mar</div><div>Mi√©</div><div>Jue</div><div>Vie</div><div>S√°b</div><div>Dom</div>
            </div>
            <div id="calendar" class="grid grid-cols-7 gap-2">
                <!-- Los d√≠as se generar√°n din√°micamente aqu√≠ --></div>
        </main>
    </div>

    <!-- Modal para el D√≠a Seleccionado --><div id="day-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-40">
        <div id="day-modal-content" class="themed-bg-secondary p-6 rounded-lg shadow-2xl w-11/12 max-w-md zoom-in flex flex-col gap-4">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold themed-text-accent">Canci√≥n del D√≠a</h2>
                <button id="close-day-modal" class="p-1 rounded-full hover:themed-bg-tertiary"><i class="fa-solid fa-xmark fa-lg"></i></button>
            </div>
             <!-- Info de la canci√≥n y Trivia --><div>
                <div id="song-info" class="text-center mb-3 min-h-[56px]">
                    <p id="song-clue" class="themed-text-secondary italic">Pista: Cargando...</p>
                    <p id="song-title" class="text-2xl font-semibold hidden">Cargando...</p>
                    <p id="song-artist" class="themed-text-secondary"></p>
                </div>
                <div id="item-unlock-message" class="text-center text-sm themed-text-accent mt-2 p-2 rounded-md bg-green-900 bg-opacity-30 hidden">
                    ¬°Has desbloqueado un nuevo objeto para tu monigote!
                </div>
            </div>
            <!-- Controles de Velocidad --><div class="flex justify-center items-center gap-2">
                <span class="text-sm font-semibold themed-text-secondary">Velocidad:</span>
                <button data-speed="0.75" class="speed-control-btn p-2 w-12 h-10 rounded-md themed-bg-tertiary hover:themed-bg-padding">0.75x</button>
                <button data-speed="1" class="speed-control-btn active p-2 w-12 h-10 rounded-md themed-bg-tertiary hover:themed-bg-padding">1x</button>
                <button data-speed="1.5" class="speed-control-btn p-2 w-12 h-10 rounded-md themed-bg-tertiary hover:themed-bg-padding">1.5x</button>
            </div>
            <!-- Notas Personales --><div class="flex flex-col gap-2">
                <h3 class="font-bold themed-text-accent">Mis Notas</h3>
                <p id="note-date" class="text-sm themed-text-secondary -mt-2">Escribe algo sobre este d√≠a.</p>
                <textarea id="note-textarea" class="w-full h-32 themed-bg-tertiary rounded-md p-2 themed-text-primary focus:outline-none focus:ring-2 themed-ring-focus" placeholder="Escribe tus pensamientos sobre la canci√≥n o el d√≠a..."></textarea>
                <button id="save-note-button" class="mt-2 w-full themed-accent-button text-gray-900 font-bold py-2 px-4 rounded-lg transition-colors">Guardar Nota</button>
            </div>
        </div>
    </div>

    <!-- Modales para Estad√≠sticas y Logros --><div id="stats-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="themed-bg-secondary p-6 rounded-lg shadow-2xl w-11/12 max-w-md zoom-in">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold themed-text-accent">Estad√≠sticas del Mes</h2>
                <button id="close-stats-modal" class="p-1 rounded-full hover:themed-bg-tertiary"><i class="fa-solid fa-xmark fa-lg"></i></button>
            </div>
            <div id="stats-content" class="max-h-80 overflow-y-auto"></div>
        </div>
    </div>

    <div id="achievements-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="themed-bg-secondary p-6 rounded-lg shadow-2xl w-11/12 max-w-lg zoom-in">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold themed-text-accent">Mis Logros</h2>
                <button id="close-achievements-modal" class="p-1 rounded-full hover:themed-bg-tertiary"><i class="fa-solid fa-xmark fa-lg"></i></button>
            </div>
            <div id="achievements-content" class="max-h-96 overflow-y-auto grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>
    </div>

    <!-- Modal para el Armario del Monigote --><div id="wardrobe-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="themed-bg-secondary p-6 rounded-lg shadow-2xl w-11/12 max-w-xl zoom-in">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold themed-text-accent">Armario del Monigote</h2>
                <button id="close-wardrobe-modal" class="p-1 rounded-full hover:themed-bg-tertiary"><i class="fa-solid fa-xmark fa-lg"></i></button>
            </div>
            <div id="wardrobe-items" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 max-h-96 overflow-y-auto">
                <!-- Items del armario se cargar√°n aqu√≠ --><div class="themed-bg-tertiary rounded-lg p-4 text-center item-card selected" data-item-id="none">
                    <i class="fa-solid fa-circle-xmark fa-3x themed-text-primary mb-2"></i>
                    <p class="text-sm font-semibold themed-text-primary">Ninguno</p>
                </div>
            </div>
            <div class="mt-4 text-center">
                <button id="clear-selected-item" class="themed-accent-button text-gray-900 font-bold py-2 px-4 rounded-lg transition-colors hidden">
                    Quitar Objeto Actual
                </button>
            </div>
        </div>
    </div>
    
    <!-- Toast para notificar logros --><div id="toast-container" class="fixed bottom-5 left-1/2 -translate-x-1/2 z-50"></div>

    <!-- Reproductor y Monigote Bailar√≠n Flotante -->
    <div id="global-player-container" class="fixed bottom-5 right-5 z-50 hidden flex flex-col items-center gap-2">
        <canvas id="danceCanvas" width="150" height="150"></canvas>
        <audio id="audioPlayer" controls class="w-48"></audio>
    </div>
    
    <!-- Input de archivo oculto para MP3 (compartido por todos los botones) -->
    <input type="file" id="mp3-file-input" accept=".mp3,audio/*" class="hidden">
    
<script type="module">
    // --- CONFIGURACI√ìN DE TEMAS ---
    const themes = {
        basico: { '--font-main': "'Inter', sans-serif", '--bg-primary': '#111827', '--bg-secondary': '#1f2937', '--bg-tertiary': '#374151', '--bg-padding': '#0f172a', '--text-primary': '#F9FAFB', '--text-secondary': '#9ca3af', '--accent-primary': '#FBBF24', '--accent-primary-hover': '#F59E0B', '--day-selected': '#1D4ED8', '--day-current-border': '#FBBF24' },
        oceanico: { '--font-main': "'Poppins', sans-serif", '--bg-primary': '#0c243b', '--bg-secondary': '#113a5d', '--bg-tertiary': '#1e4e7b', '--bg-padding': '#081c2f', '--text-primary': '#e0f2fe', '--text-secondary': '#bae6fd', '--accent-primary': '#38bdf8', '--accent-primary-hover': '#0ea5e9', '--day-selected': '#075985', '--day-current-border': '#38bdf8' },
        bosque: { '--font-main': "'Merriweather', serif", '--bg-primary': '#14281d', '--bg-secondary': '#2a4838', '--bg-tertiary': '#416c52', '--bg-padding': '#0f2017', '--text-primary': '#ecfdf5', '--text-secondary': '#a7f3d0', '--accent-primary': '#4ade80', '--accent-primary-hover': '#22c55e', '--day-selected': '#166534', '--day-current-border': '#4ade80' },
        playa: { '--font-main': "'Montserrat', sans-serif", '--bg-primary': '#fef3c7', '--bg-secondary': '#fffbeb', '--bg-tertiary': '#fde68a', '--bg-padding': '#fefce8', '--text-primary': '#44403c', '--text-secondary': '#78716c', '--accent-primary': '#2563eb', '--accent-primary-hover': '#1d4ed8', '--day-selected': '#60a5fa', '--day-current-border': '#2563eb' },
        retro: { '--font-main': "'Press Start 2P', cursive", '--bg-primary': '#1e1b4b', '--bg-secondary': '#312e81', '--bg-tertiary': '#4338ca', '--bg-padding': '#1a173c', '--text-primary': '#e0e7ff', '--text-secondary': '#c7d2fe', '--accent-primary': '#ec4899', '--accent-primary-hover': '#db2777', '--day-selected': '#7c3aed', '--day-current-border': '#ec4899' },
    };

    // --- CONFIGURACI√ìN DE CANCIONES Y TEMAS MENSUALES ---
    const defaultSongs = [
        { title: "Secrets", artist: "OneRepublic", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3", clue: "Perfecta para guardar un secreto." },
        { title: "Can't Feel My Face", artist: "The Weeknd", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3", clue: "No puedo sentir mi cara..." },
        { title: "Lonely (Traducida)", artist: "Imagine Dragons", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3", clue: "Una canci√≥n de una banda moderna popular." },
        { title: "Ride It", artist: "Jay Sean", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3", clue: "Un cl√°sico de R&B." },
        { title: "Faint", artist: "Linkin Park", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3", clue: "Un himno de nu-metal." },
        { title: "Life Is a Highway", artist: "Rascal Flatts", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-6.mp3", clue: "Una canci√≥n cl√°sica sobre la carretera." },
        { title: "Dracula", artist: "Tame Impala", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-7.mp3", clue: "Un t√≠tulo... ¬øchupasangre?" }
    ];
    
    const monthlyThemes = {
        9: { // Octubre (0-indexed)
            name: "ü§ò Rocktubre ü§ò",
            songs: [ { title: "Highway to Hell", artist: "AC/DC", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-14.mp3", clue: "Un cl√°sico sobre una autopista al infierno." }, { title: "Stairway to Heaven", artist: "Led Zeppelin", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3", clue: "Una balada √©pica que sube hasta el cielo." }, { title: "Bohemian Rhapsody", artist: "Queen", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-6.mp3", clue: "Is this the real life? Is this just fantasy?" }, { title: "Smells Like Teen Spirit", artist: "Nirvana", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-14.mp3", clue: "El himno de la generaci√≥n grunge de los 90." }, { title: "Back in Black", artist: "AC/DC", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-14.mp3", clue: "Un riff de guitarra inconfundible." }, { title: "Sweet Child o' Mine", artist: "Guns N' Roses", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3", clue: "Where do we go now?" }, { title: "Enter Sandman", artist: "Metallica", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-14.mp3", clue: "Exit light, enter night..." }, { title: "Hotel California", artist: "Eagles", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3", clue: "Puedes hacer el check-out, pero nunca irte." }, { title: "Another Brick in the Wall", artist: "Pink Floyd", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-10.mp3", clue: "We don't need no education." }, { title: "Thunderstruck", artist: "AC/DC", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-14.mp3", clue: "Un trueno recorre esta canci√≥n." }, { title: "Livin' on a Prayer", artist: "Bon Jovi", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3", clue: "Woah, we're half way there!" }, { title: "Born to Run", artist: "Bruce Springsteen", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-12.mp3", clue: "El himno de la carretera y la libertad." }, { title: "Come As You Are", artist: "Nirvana", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-14.mp3", clue: "As a friend, as a known enemy." }, { title: "Welcome to the Jungle", artist: "Guns N' Roses", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-14.mp3", clue: "Una bienvenida a una selva muy particular." }, { title: "Black Dog", artist: "Led Zeppelin", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-14.mp3", clue: "Hey, hey, mama, said the way you move..." }, { title: "The Unforgiven", artist: "Metallica", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-10.mp3", clue: "Una balada de heavy metal sobre el perd√≥n." }, { title: "We Will Rock You", artist: "Queen", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-7.mp3", clue: "El ritmo se marca con los pies y las manos." }, { title: "Paranoid", artist: "Black Sabbath", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-14.mp3", clue: "Uno de los pilares del heavy metal." }, { title: "Paint It, Black", artist: "The Rolling Stones", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-12.mp3", clue: "Veo una puerta roja y quiero pintarla de..." }, { title: "Satisfaction", artist: "The Rolling Stones", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-12.mp3", clue: "I can't get no..." }, { title: "Whole Lotta Love", artist: "Led Zeppelin", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-14.mp3", clue: "You need coolin', baby, I'm not foolin'." }, { title: "Master of Puppets", artist: "Metallica", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-14.mp3", clue: "Tirando de tus hilos..." }, { title: "Kashmir", artist: "Led Zeppelin", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-6.mp3", clue: "Un viaje √©pico a una tierra lejana." }, { title: "Don't Stop Me Now", artist: "Queen", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-7.mp3", clue: "I'm having such a good time, I'm having a ball." }, { title: "Iron Man", artist: "Black Sabbath", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-14.mp3", clue: "Has he lost his mind? Can he see or is he blind?" }, { title: "You Shook Me All Night Long", artist: "AC/DC", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-14.mp3", clue: "Una noche de rock and roll sin fin." }, { title: "Crazy Train", artist: "Ozzy Osbourne", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-14.mp3", clue: "All aboard! Ha-ha-ha..." }, { title: "Rock and Roll All Nite", artist: "KISS", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-14.mp3", clue: "Y festejar todos los d√≠as." }, { title: "Immigrant Song", artist: "Led Zeppelin", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-14.mp3", clue: "El martillo de los dioses nos guiar√°." }, { title: "November Rain", artist: "Guns N' Roses", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3", clue: "Una lluvia muy melanc√≥lica de oto√±o." }, { title: "Nothing Else Matters", artist: "Metallica", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3", clue: "So close, no matter how far..." } ]
        }
    };
    
    // --- CONFIGURACI√ìN DE LOGROS ---
    const achievements = {
        WEEK_STREAK: { id: 'WEEK_STREAK', name: '¬°Racha Semanal!', description: 'Escuchaste m√∫sica 7 d√≠as seguidos.', icon: 'fa-solid fa-calendar-check' },
        MONTH_STREAK: { id: 'MONTH_STREAK', name: '¬°Mel√≥mano Mensual!', description: 'Escuchaste m√∫sica 30 d√≠as seguidos.', icon: 'fa-solid fa-trophy' },
        ROCKTOBER_COMPLETE: { id: 'ROCKTOBER_COMPLETE', name: 'Leyenda del Rock', description: '¬°Escuchaste todas las canciones de Rocktubre!', icon: 'fa-solid fa-guitar' },
    };

    // --- CONFIGURACI√ìN DE OBJETOS PARA EL MONIGOTE ---
    const dailyItems = {
        1: { id: "sunglasses", name: "Gafas de Sol", icon: "fa-solid fa-glasses", type: "head" },
        2: { id: "pumpkin-head", name: "Calabaza Halloween", icon: "fa-solid fa-face-grin-squint", type: "head" },
        3: { id: "ghost-costume", name: "Disfraz de Fantasma", icon: "fa-solid fa-ghost", type: "body" },
        4: { id: "wizard-hat", name: "Sombrero de Mago", icon: "fa-solid fa-hat-wizard", type: "head" },
        5: { id: "tie", name: "Corbata Elegante", icon: "fa-solid fa-user-tie", type: "body" },
        6: { id: "headphones", name: "Auriculares", icon: "fa-solid fa-headphones", type: "head" },
        7: { id: "cape", name: "Capa de H√©roe", icon: "fa-solid fa-mask", type: "body" },
        8: { id: "crown", name: "Corona de Rey", icon: "fa-solid fa-crown", type: "head" },
        9: { id: "scarf", name: "Bufanda C√°lida", icon: "fa-solid fa-scarf", type: "neck" },
        10: { id: "backpack", name: "Mochila Aventurera", icon: "fa-solid fa-backpack", type: "back" },
        11: { id: "mustache", name: "Bigote Falso", icon: "fa-solid fa-user-secret", type: "face" },
        12: { id: "flower-hat", name: "Sombrero de Flor", icon: "fa-solid fa-flower", type: "head" },
        13: { id: "guitar", name: "Guitarra El√©ctrica", icon: "fa-solid fa-guitar", type: "hand-right" },
        14: { id: "bow-tie", name: "Pajarita", icon: "fa-solid fa-user-tie", type: "neck" },
        15: { id: "chef-hat", name: "Gorro de Chef", icon: "fa-solid fa-hat-chef", type: "head" },
        16: { id: "pirate-patch", name: "Parche Pirata", icon: "fa-solid fa-eye-slash", type: "face" },
        17: { id: "feather-boa", name: "Boa de Plumas", icon: "fa-solid fa-feather", type: "neck" },
        18: { id: "camera", name: "C√°mara de Fotos", icon: "fa-solid fa-camera", type: "hand-left" },
        19: { id: "party-hat", name: "Sombrero de Fiesta", icon: "fa-solid fa-cake-candles", type: "head" },
        20: { id: "angel-wings", name: "Alas de √Ångel", icon: "fa-solid fa-dove", type: "back" },
        21: { id: "devil-horns", name: "Cuernos de Diablo", icon: "fa-solid fa-user-ninja", type: "head" },
        22: { id: "microphone", name: "Micr√≥fono", icon: "fa-solid fa-microphone", type: "hand-right" },
        23: { id: "lab-coat", name: "Bata de Cient√≠fico", icon: "fa-solid fa-flask", type: "body" },
        24: { id: "detective-hat", name: "Gorro de Detective", icon: "fa-solid fa-magnifying-glass", type: "head" },
        25: { id: "ballet-skirt", name: "Falda de Ballet", icon: "fa-solid fa-person-dress", type: "body" },
        26: { id: "football-helmet", name: "Casco de F√∫tbol", icon: "fa-solid fa-football", type: "head" },
        27: { id: "superhero-mask", name: "M√°scara de H√©roe", icon: "fa-solid fa-user-secret", type: "face" },
        28: { id: "fez-hat", name: "Gorro Fez", icon: "fa-solid fa-graduation-cap", type: "head" },
        29: { id: "propeller-hat", name: "Gorro H√©lice", icon: "fa-solid fa-paper-plane", type: "head" },
        30: { id: "viking-helmet", name: "Casco Vikingo", icon: "fa-solid fa-shield-halved", type: "head" },
        31: { id: "witch-hat", name: "Sombrero de Bruja", icon: "fa-solid fa-cat", type: "head" }
    };


    let nav = 0, selectedDate = null, currentPlaylist = [], currentPlaylistIndex = 0;
    let unlockedItems = []; 
    let selectedItem = "none"; 
    
    // --- DOM ELEMENTS ---
    const calendar = document.getElementById('calendar');
    const monthDisplay = document.getElementById('monthDisplay');
    const dayModal = document.getElementById('day-modal');
    const audioPlayer = document.getElementById('audioPlayer');
    const songClue = document.getElementById('song-clue');
    const songTitle = document.getElementById('song-title');
    const songArtist = document.getElementById('song-artist');
    const noteTextarea = document.getElementById('note-textarea');
    const noteDate = document.getElementById('note-date');
    const saveNoteButton = document.getElementById('save-note-button');
    const globalPlayerContainer = document.getElementById('global-player-container');
    const danceCanvas = document.getElementById('danceCanvas');
    const danceCtx = danceCanvas.getContext('2d');
    const itemUnlockMessage = document.getElementById('item-unlock-message');
    let animationFrameId;

    // NUEVOS DOM ELEMENTS
    const mp3FileInput = document.getElementById('mp3-file-input');

    // --- L√ìGICA DE LIMPIEZA DE URL DE OBJETO ---
    function revokeLocalMp3ForDay(dateString) {
        const mp3Cache = JSON.parse(localStorage.getItem('local-mp3-cache') || '{}');
        const oldLocalSong = mp3Cache[dateString];
        if (oldLocalSong && oldLocalSong.src.startsWith('blob:')) {
            URL.revokeObjectURL(oldLocalSong.src);
            // console.log(`[Cache Cleanup] Revoked old blob URL for ${dateString}`);
        }
    }
    
    // --- THEME & ANIMATION LOGIC (Sin Cambios) ---
    function applyTheme(themeName) {
        const theme = themes[themeName] || themes.basico;
        const root = document.documentElement;
        Object.entries(theme).forEach(([key, value]) => root.style.setProperty(key, value));
        const themeSwitcher = document.getElementById('theme-switcher');
        if (themeSwitcher) {
            themeSwitcher.value = themeName;
        } else {
            console.warn("Element with ID 'theme-switcher' not found.");
        }
        document.body.classList.toggle('theme-retro', themeName === 'retro');
    }
    function saveTheme(themeName) { localStorage.setItem('musical-calendar-theme', themeName); }

    let lastTime = 0;
    let baseSpeed = 0.005; 

    function drawRhythmicStickFigure(time) {
        danceCtx.clearRect(0, 0, danceCanvas.width, danceCanvas.height);
        danceCtx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-primary');
        danceCtx.lineWidth = 3;
        const currentSpeed = baseSpeed * audioPlayer.playbackRate;
        const bobFreq = currentSpeed * 2;
        const swayFreq = currentSpeed * 0.7;
        const armFreq = currentSpeed;
        const legFreq = currentSpeed * 2;
        const bobAmp = 4;
        const swayAmp = 6;
        const armAmp = 25;
        const legKneeAmp = 15;

        const bodySway = Math.sin(time * swayFreq) * swayAmp;
        const bodyBob = Math.abs(Math.sin(time * bobFreq)) * bobAmp; 

        const baseX = 75 + bodySway;
        const headY = 50 - bodyBob;
        const shoulderY = 65 - bodyBob;
        const hipY = 110 - bodyBob;
        const footY = 140;

        // Draw Head
        danceCtx.beginPath();
        danceCtx.arc(baseX, headY, 15, 0, Math.PI * 2);
        danceCtx.stroke();

        // Draw Body
        danceCtx.beginPath();
        danceCtx.moveTo(baseX, shoulderY);
        danceCtx.lineTo(baseX, hipY);
        danceCtx.stroke();

        // Draw Arms
        const lArmAngle = Math.sin(time * armFreq) * armAmp;
        const rArmAngle = Math.cos(time * armFreq * 1.5) * armAmp;
        danceCtx.beginPath();
        danceCtx.moveTo(baseX, shoulderY);
        danceCtx.lineTo(baseX - 25 - lArmAngle, shoulderY + 20);
        danceCtx.stroke();
        danceCtx.beginPath();
        danceCtx.moveTo(baseX, shoulderY);
        danceCtx.lineTo(baseX + 25 + rArmAngle, shoulderY + 20);
        danceCtx.stroke();

        // Draw Legs
        const lLegKnee = Math.abs(Math.cos(time * legFreq)) * legKneeAmp;
        const rLegKnee = Math.abs(Math.sin(time * legFreq)) * legKneeAmp;
        danceCtx.beginPath();
        danceCtx.moveTo(baseX, hipY);
        danceCtx.lineTo(baseX - 15, hipY + lLegKnee);
        danceCtx.lineTo(baseX - 20, footY);
        danceCtx.stroke();
        danceCtx.beginPath();
        danceCtx.moveTo(baseX, hipY);
        danceCtx.lineTo(baseX + 15, hipY + rLegKnee);
        danceCtx.lineTo(baseX + 20, footY);
        danceCtx.stroke();

        // --- Dibuja los objetos del monigote ---
        
        const equippedItem = Object.values(dailyItems).find(i => i.id === selectedItem);
        let itemToDraw = null;
        if (selectedItem !== "none" && equippedItem) {
            itemToDraw = equippedItem; 
        }

        if (itemToDraw) {
            danceCtx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent-primary');
            danceCtx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent-primary-hover'); 
            danceCtx.lineWidth = 2; 

            // Dibuja el objeto seg√∫n su ID (simplificado)
            switch (itemToDraw.id) {
                case "sunglasses": 
                    danceCtx.fillRect(baseX - 15, headY - 5, 30, 8); 
                    danceCtx.beginPath();
                    danceCtx.arc(baseX - 8, headY -1, 6, 0, Math.PI * 2); 
                    danceCtx.stroke(); 
                    danceCtx.fill();   
                    danceCtx.beginPath();
                    danceCtx.arc(baseX + 8, headY - 1, 6, 0, Math.PI * 2); 
                    danceCtx.stroke();
                    danceCtx.fill();
                    break;
                case "pumpkin-head": 
                    danceCtx.beginPath();
                    danceCtx.arc(baseX, headY, 20, 0, Math.PI * 2); 
                    danceCtx.fill();
                    danceCtx.stroke();
                    danceCtx.fillStyle = 'black'; 
                    danceCtx.fillRect(baseX - 10, headY - 8, 5, 5); 
                    danceCtx.fillRect(baseX + 5, headY - 8, 5, 5); 
                    danceCtx.beginPath(); 
                    danceCtx.moveTo(baseX - 10, headY + 5);
                    danceCtx.lineTo(baseX + 10, headY + 5);
                    danceCtx.lineWidth = 2;
                    danceCtx.stroke();
                    danceCtx.lineWidth = 3; 
                    break;
                case "ghost-costume": 
                    danceCtx.beginPath();
                    danceCtx.moveTo(baseX - 30, shoulderY - 10);
                    danceCtx.lineTo(baseX + 30, shoulderY - 10);
                    danceCtx.lineTo(baseX + 25, footY + 15); 
                    danceCtx.lineTo(baseX, footY + 10); 
                    danceCtx.lineTo(baseX - 25, footY + 15);
                    danceCtx.closePath();
                    danceCtx.fill();
                    danceCtx.stroke();
                    danceCtx.fillStyle = 'black';
                    danceCtx.beginPath();
                    danceCtx.arc(baseX - 7, headY - 3, 4, 0, Math.PI * 2);
                    danceCtx.fill();
                    danceCtx.beginPath();
                    danceCtx.arc(baseX + 7, headY - 3, 4, 0, Math.PI * 2);
                    danceCtx.fill();
                   break;
                case "wizard-hat": 
                    danceCtx.beginPath();
                    danceCtx.moveTo(baseX - 25, headY - 10); 
                    danceCtx.lineTo(baseX + 25, headY - 10);
                    danceCtx.lineTo(baseX, headY - 45); 
                    danceCtx.closePath();
                    danceCtx.fill();
                    danceCtx.stroke();
                    break;
                case "tie": 
                    danceCtx.beginPath();
                    danceCtx.moveTo(baseX - 4, shoulderY); 
                    danceCtx.lineTo(baseX + 4, shoulderY);
                    danceCtx.lineTo(baseX + 4, shoulderY + 8);
                    danceCtx.lineTo(baseX - 4, shoulderY + 8);
                    danceCtx.closePath();
                    danceCtx.fill();
                    danceCtx.stroke();
                    danceCtx.beginPath(); 
                    danceCtx.moveTo(baseX, shoulderY + 8);
                    danceCtx.lineTo(baseX + 6, hipY - 5);
                    danceCtx.lineTo(baseX, hipY);
                    danceCtx.lineTo(baseX - 6, hipY - 5);
                    danceCtx.closePath();
                    danceCtx.fill();
                    danceCtx.stroke();
                    break;
                case "headphones": 
                    danceCtx.beginPath();
                    danceCtx.arc(baseX, headY - 15, 20, Math.PI, 0); 
                    danceCtx.stroke();
                    danceCtx.beginPath();
                    danceCtx.arc(baseX - 15, headY, 7, 0, Math.PI * 2); 
                    danceCtx.fill();
                    danceCtx.stroke();
                    danceCtx.beginPath();
                    danceCtx.arc(baseX + 15, headY, 7, 0, Math.PI * 2); 
                    danceCtx.fill();
                    danceCtx.stroke();
                    break;
                case "cape": 
                    danceCtx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent-primary');
                    danceCtx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent-primary-hover');
                    danceCtx.lineWidth = 2;
                    danceCtx.beginPath();
                    danceCtx.moveTo(baseX - 15, shoulderY); 
                    danceCtx.lineTo(baseX - 40, footY + 10); 
                    danceCtx.quadraticCurveTo(baseX, footY + 20, baseX + 40, footY + 10); 
                    danceCtx.lineTo(baseX + 15, shoulderY);
                    danceCtx.lineTo(baseX - 15, shoulderY); 
                    danceCtx.fill();
                    danceCtx.stroke();
                    danceCtx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-primary');
                    danceCtx.lineWidth = 3;
                    danceCtx.beginPath(); danceCtx.moveTo(baseX, shoulderY); danceCtx.lineTo(baseX, hipY); danceCtx.stroke(); 
                    danceCtx.beginPath(); danceCtx.arc(baseX, headY, 15, 0, Math.PI * 2); danceCtx.stroke(); 
                    break; 
                case "crown": 
                    danceCtx.beginPath();
                    danceCtx.moveTo(baseX - 15, headY - 15); 
                    danceCtx.lineTo(baseX + 15, headY - 15);
                    danceCtx.lineTo(baseX + 15, headY - 25);
                    danceCtx.lineTo(baseX + 10, headY - 20);
                    danceCtx.lineTo(baseX + 5, headY - 25);
                    danceCtx.lineTo(baseX, headY - 20);
                    danceCtx.lineTo(baseX - 5, headY - 25);
                    danceCtx.lineTo(baseX - 10, headY - 20);
                    danceCtx.lineTo(baseX - 15, headY - 25);
                    danceCtx.closePath();
                    danceCtx.fill();
                    danceCtx.stroke();
                    break;
                case "scarf": 
                    danceCtx.beginPath();
                    danceCtx.moveTo(baseX - 18, shoulderY + 5); 
                    danceCtx.quadraticCurveTo(baseX, shoulderY + 15, baseX + 18, shoulderY + 5); 
                    danceCtx.lineTo(baseX + 10, hipY - 10); 
                    danceCtx.lineTo(baseX + 5, hipY - 5); 
                    danceCtx.lineTo(baseX - 10, shoulderY + 12); 
                    danceCtx.closePath();
                    danceCtx.fill();
                    danceCtx.stroke();
                    break;
                case "backpack": 
                    danceCtx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent-primary');
                    danceCtx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent-primary-hover');
                    danceCtx.lineWidth = 2;
                    danceCtx.fillRect(baseX - 15, shoulderY + 5, 30, 35); 
                    danceCtx.strokeRect(baseX - 15, shoulderY + 5, 30, 35);
                    danceCtx.beginPath();
                    danceCtx.moveTo(baseX - 15, shoulderY + 8);
                    danceCtx.lineTo(baseX - 5, shoulderY - 5); 
                    danceCtx.moveTo(baseX + 15, shoulderY + 8);
                    danceCtx.lineTo(baseX + 5, shoulderY - 5); 
                    danceCtx.stroke();
                    danceCtx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-primary');
                    danceCtx.lineWidth = 3;
                    danceCtx.beginPath(); danceCtx.moveTo(baseX, shoulderY); danceCtx.lineTo(baseX, hipY); danceCtx.stroke();
                    danceCtx.beginPath(); danceCtx.arc(baseX, headY, 15, 0, Math.PI * 2); danceCtx.stroke();
                    break; 
                case "mustache": 
                    danceCtx.beginPath();
                    danceCtx.moveTo(baseX - 12, headY + 5); 
                    danceCtx.quadraticCurveTo(baseX - 6, headY + 12, baseX, headY + 7); 
                    danceCtx.quadraticCurveTo(baseX + 6, headY + 12, baseX + 12, headY + 5); 
                    danceCtx.fill();
                    danceCtx.stroke();
                    break;
                case "flower-hat": 
                    danceCtx.beginPath();
                    danceCtx.arc(baseX, headY - 15, 10, 0, Math.PI * 2);
                    danceCtx.fill();
                    danceCtx.stroke();
                    for (let i = 0; i < 6; i++) {
                        const angle = (i / 6) * Math.PI * 2;
                        const petalX = baseX + Math.cos(angle) * 15;
                        const petalY = headY - 15 + Math.sin(angle) * 15;
                        danceCtx.beginPath();
                        danceCtx.arc(petalX, petalY, 6, 0, Math.PI * 2);
                        danceCtx.fillStyle = 'white'; 
                        danceCtx.fill();
                        danceCtx.stroke();
                    }
                    danceCtx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent-primary'); 
                   break;
                case "guitar": 
                    danceCtx.beginPath();
                    danceCtx.moveTo(baseX + 20, shoulderY + 10); 
                    danceCtx.lineTo(baseX + 25, headY - 10); 
                    danceCtx.lineWidth = 4; 
                    danceCtx.stroke();
                    danceCtx.lineWidth = 2; 
                    danceCtx.beginPath();
                    danceCtx.ellipse(baseX + 30, shoulderY + 35, 12, 18, Math.PI / 4, 0, Math.PI * 2); 
                    danceCtx.fill();
                    danceCtx.stroke();
                    danceCtx.beginPath();
                    danceCtx.ellipse(baseX + 25, shoulderY + 15, 8, 12, Math.PI / 4, 0, Math.PI * 2); 
                    danceCtx.fill();
                    danceCtx.stroke();
                    danceCtx.beginPath();
                    danceCtx.arc(baseX + 22, shoulderY + 15, 5, 0, Math.PI * 2);
                    danceCtx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-primary'); 
                    danceCtx.fill();
                   break;
                case "bow-tie": 
                    danceCtx.beginPath();
                    danceCtx.moveTo(baseX - 10, shoulderY + 5); 
                    danceCtx.lineTo(baseX, shoulderY);
                    danceCtx.lineTo(baseX, shoulderY + 10);
                    danceCtx.closePath();
                    danceCtx.fill();
                    danceCtx.stroke();
                    danceCtx.beginPath();
                    danceCtx.moveTo(baseX + 10, shoulderY + 5); 
                    danceCtx.lineTo(baseX, shoulderY);
                    danceCtx.lineTo(baseX, shoulderY + 10);
                    danceCtx.closePath();
                    danceCtx.fill();
                    danceCtx.stroke();
                    danceCtx.beginPath(); 
                    danceCtx.arc(baseX, shoulderY + 5, 3, 0, Math.PI * 2);
                    danceCtx.fill();
                    danceCtx.stroke();
                    break;
                case "chef-hat": 
                   danceCtx.fillRect(baseX - 15, headY - 15, 30, 10);
                   danceCtx.strokeRect(baseX - 15, headY - 15, 30, 10);
                   danceCtx.beginPath();
                   danceCtx.arc(baseX, headY - 25, 20, Math.PI, 0); 
                   danceCtx.quadraticCurveTo(baseX + 25, headY - 15, baseX + 15, headY - 15);
                   danceCtx.lineTo(baseX - 15, headY - 15);
                   danceCtx.quadraticCurveTo(baseX - 25, headY - 15, baseX - 20, headY - 25);
                   danceCtx.closePath();
                   danceCtx.fill();
                   danceCtx.stroke();
                    break;
                case "pirate-patch": 
                    danceCtx.beginPath();
                    danceCtx.ellipse(baseX - 8, headY, 7, 5, 0, 0, Math.PI * 2); 
                    danceCtx.fillStyle = 'black'; 
                    danceCtx.fill();
                    danceCtx.beginPath(); 
                    danceCtx.moveTo(baseX - 15, headY - 3);
                    danceCtx.lineTo(baseX + 15, headY - 3);
                    danceCtx.strokeStyle = 'black';
                    danceCtx.lineWidth = 1;
                    danceCtx.stroke();
                    danceCtx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent-primary-hover'); 
                    danceCtx.lineWidth = 2; 
                   break;
                case "feather-boa": 
                    for (let i = 0; i < 10; i++) {
                        const angle = (i / 10) * Math.PI * 2;
                        const boaX = baseX + Math.cos(angle) * 15; 
                        const boaY = shoulderY + 5 + Math.sin(angle) * 8; 
                        const radius = 4 + Math.random() * 3; 
                        danceCtx.beginPath();
                        danceCtx.arc(boaX, boaY, radius, 0, Math.PI * 2);
                        danceCtx.fill();
                    }
                   break;
                case "camera": 
                    const camX = baseX - 25 - lArmAngle - 10; 
                    const camY = shoulderY + 20;
                    danceCtx.fillRect(camX - 10, camY - 8, 20, 16); 
                    danceCtx.strokeRect(camX - 10, camY - 8, 20, 16);
                    danceCtx.beginPath(); 
                    danceCtx.arc(camX, camY, 6, 0, Math.PI * 2);
                    danceCtx.fill();
                    danceCtx.stroke();
                    danceCtx.fillRect(camX - 2, camY - 12, 4, 4); 
                   break;
                case "party-hat": 
                    danceCtx.beginPath();
                    danceCtx.moveTo(baseX - 12, headY - 5); 
                    danceCtx.lineTo(baseX + 12, headY - 5);
                    danceCtx.lineTo(baseX, headY - 35); 
                    danceCtx.closePath();
                    danceCtx.fill();
                    danceCtx.stroke();
                    danceCtx.beginPath(); 
                    danceCtx.arc(baseX, headY - 37, 3, 0, Math.PI * 2);
                    danceCtx.fill();
                   break;
                case "angel-wings": 
                    danceCtx.fillStyle = 'white'; 
                    danceCtx.strokeStyle = '#ddd'; 
                    danceCtx.lineWidth = 1;
                    danceCtx.beginPath();
                    danceCtx.moveTo(baseX - 5, shoulderY); 
                    danceCtx.quadraticCurveTo(baseX - 40, shoulderY - 20, baseX - 50, shoulderY + 10); 
                    danceCtx.quadraticCurveTo(baseX - 35, shoulderY + 30, baseX - 5, shoulderY + 10); 
                    danceCtx.closePath();
                    danceCtx.fill();
                    danceCtx.stroke();
                    danceCtx.beginPath();
                    danceCtx.moveTo(baseX + 5, shoulderY);
                    danceCtx.quadraticCurveTo(baseX + 40, shoulderY - 20, baseX + 50, shoulderY + 10);
                    danceCtx.quadraticCurveTo(baseX + 35, shoulderY + 30, baseX + 5, shoulderY + 10);
                    danceCtx.closePath();
                    danceCtx.fill();
                    danceCtx.stroke();
                    danceCtx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-primary');
                    danceCtx.lineWidth = 3;
                    danceCtx.beginPath(); danceCtx.moveTo(baseX, shoulderY); danceCtx.lineTo(baseX, hipY); danceCtx.stroke(); 
                    danceCtx.beginPath(); danceCtx.arc(baseX, headY, 15, 0, Math.PI * 2); danceCtx.stroke();
                   break; 
                case "devil-horns": 
                    danceCtx.fillStyle = 'red'; 
                    danceCtx.strokeStyle = 'darkred'; 
                    danceCtx.beginPath();
                    danceCtx.moveTo(baseX - 8, headY - 15);
                    danceCtx.quadraticCurveTo(baseX - 15, headY - 30, baseX - 5, headY - 25); 
                    danceCtx.closePath();
                    danceCtx.fill();
                    danceCtx.stroke();
                    danceCtx.beginPath();
                    danceCtx.moveTo(baseX + 8, headY - 15);
                    danceCtx.quadraticCurveTo(baseX + 15, headY - 30, baseX + 5, headY - 25); 
                    danceCtx.closePath();
                    danceCtx.fill();
                    danceCtx.stroke();
                   break;
                case "microphone": 
                    const micX = baseX + 25 + rArmAngle + 5; 
                    const micY = shoulderY + 20;
                    danceCtx.fillStyle = 'gray'; 
                    danceCtx.fillRect(micX - 3, micY, 6, 15); 
                    danceCtx.strokeRect(micX - 3, micY, 6, 15);
                    danceCtx.fillStyle = 'darkgray'; 
                    danceCtx.beginPath(); 
                    danceCtx.arc(micX, micY, 5, 0, Math.PI * 2);
                    danceCtx.fill();
                    danceCtx.stroke();
                   break;
                case "lab-coat": 
                    danceCtx.fillStyle = 'white'; 
                    danceCtx.strokeStyle = '#ccc'; 
                    danceCtx.lineWidth = 1;
                    danceCtx.beginPath();
                    danceCtx.moveTo(baseX - 20, shoulderY); 
                    danceCtx.lineTo(baseX - 20, footY); 
                    danceCtx.lineTo(baseX + 20, footY); 
                    danceCtx.lineTo(baseX + 20, shoulderY); 
                    danceCtx.lineTo(baseX + 5, shoulderY);
                    danceCtx.lineTo(baseX + 10, shoulderY + 15);
                    danceCtx.lineTo(baseX - 10, shoulderY + 15);
                    danceCtx.lineTo(baseX - 5, shoulderY);
                    danceCtx.closePath(); 
                    danceCtx.fill();
                    danceCtx.stroke();
                    danceCtx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-primary');
                    danceCtx.lineWidth = 3;
                    danceCtx.beginPath(); danceCtx.moveTo(baseX, shoulderY); danceCtx.lineTo(baseX, hipY); danceCtx.stroke(); 
                    danceCtx.beginPath(); danceCtx.arc(baseX, headY, 15, 0, Math.PI * 2); danceCtx.stroke(); 
                   break; 
                case "detective-hat": 
                    danceCtx.fillStyle = '#a0522d'; 
                    danceCtx.strokeStyle = '#8b4513';
                    danceCtx.beginPath();
                    danceCtx.ellipse(baseX, headY - 8, 22, 6, 0, 0, Math.PI * 2);
                    danceCtx.fill();
                    danceCtx.stroke();
                    danceCtx.beginPath();
                    danceCtx.ellipse(baseX, headY - 15, 15, 8, 0, Math.PI, 0); 
                    danceCtx.lineTo(baseX - 15, headY - 15); 
                    danceCtx.fill();
                    danceCtx.stroke();
                   break;
                case "ballet-skirt": 
                    danceCtx.fillStyle = 'pink';
                    danceCtx.strokeStyle = 'deeppink';
                    danceCtx.beginPath();
                    danceCtx.moveTo(baseX - 20, hipY); 
                    danceCtx.quadraticCurveTo(baseX - 15, hipY + 15, baseX, hipY + 10);
                    danceCtx.quadraticCurveTo(baseX + 15, hipY + 15, baseX + 20, hipY); 
                    danceCtx.closePath();
                    danceCtx.fill();
                    danceCtx.stroke();
                   break;
                case "football-helmet": 
                    danceCtx.fillStyle = 'blue'; 
                    danceCtx.strokeStyle = 'darkblue';
                    danceCtx.beginPath();
                    danceCtx.arc(baseX, headY, 18, 0, Math.PI * 2);
                    danceCtx.fill();
                    danceCtx.stroke();
                    danceCtx.beginPath();
                    danceCtx.moveTo(baseX - 15, headY + 5);
                    danceCtx.lineTo(baseX - 15, headY + 15);
                    danceCtx.lineTo(baseX + 15, headY + 15);
                    danceCtx.lineTo(baseX + 15, headY + 5);
                    danceCtx.strokeStyle = 'white'; 
                    danceCtx.lineWidth = 3;
                    danceCtx.stroke();
                    danceCtx.lineWidth = 2; 
                   break;
                case "superhero-mask": 
                    danceCtx.fillStyle = 'black'; 
                    danceCtx.beginPath();
                    danceCtx.moveTo(baseX - 18, headY - 8);
                    danceCtx.quadraticCurveTo(baseX, headY - 12, baseX + 18, headY - 8); 
                    danceCtx.lineTo(baseX + 15, headY + 2); 
                    danceCtx.quadraticCurveTo(baseX, headY + 8, baseX - 15, headY + 2); 
                    danceCtx.closePath();
                    danceCtx.fill();
                   break;
                case "fez-hat": 
                    danceCtx.fillStyle = 'darkred';
                    danceCtx.strokeStyle = 'black';
                    danceCtx.beginPath();
                    danceCtx.ellipse(baseX, headY - 5, 15, 4, 0, 0, Math.PI * 2); 
                    danceCtx.moveTo(baseX - 15, headY - 5); 
                    danceCtx.lineTo(baseX - 10, headY - 20); 
                    danceCtx.ellipse(baseX, headY - 20, 10, 3, 0, Math.PI, 0); 
                    danceCtx.lineTo(baseX + 15, headY - 5); 
                    danceCtx.fill();
                    danceCtx.stroke();
                    danceCtx.beginPath();
                    danceCtx.moveTo(baseX, headY - 20); 
                    danceCtx.lineTo(baseX + 8, headY - 10); 
                    danceCtx.stroke();
                    danceCtx.beginPath(); 
                    danceCtx.arc(baseX + 8, headY - 10, 3, 0, Math.PI * 2);
                    danceCtx.fillStyle = 'black';
                    danceCtx.fill();
                   break;
                case "propeller-hat": 
                    danceCtx.fillStyle = 'lightblue'; 
                    danceCtx.strokeStyle = 'blue';
                    danceCtx.beginPath();
                    danceCtx.arc(baseX, headY - 5, 16, Math.PI, 0);
                    danceCtx.closePath();
                    danceCtx.fill();
                    danceCtx.stroke();
                    danceCtx.beginPath();
                    danceCtx.moveTo(baseX, headY - 20);
                    danceCtx.lineTo(baseX, headY - 30);
                    danceCtx.strokeStyle = 'gray';
                    danceCtx.lineWidth = 2;
                    danceCtx.stroke();
                    danceCtx.beginPath();
                    danceCtx.moveTo(baseX - 10, headY - 30);
                    danceCtx.lineTo(baseX + 10, headY - 30);
                    danceCtx.strokeStyle = 'red'; 
                    danceCtx.lineWidth = 4;
                    danceCtx.stroke();
                    danceCtx.lineWidth = 2; 
                   break;
                case "viking-helmet": 
                    danceCtx.fillStyle = 'gray';
                    danceCtx.strokeStyle = 'darkgray';
                    danceCtx.beginPath();
                    danceCtx.arc(baseX, headY - 2, 17, Math.PI, 0); 
                    danceCtx.closePath();
                    danceCtx.fill();
                    danceCtx.stroke();
                    danceCtx.fillStyle = 'white';
                    danceCtx.strokeStyle = 'black';
                    danceCtx.beginPath();
                    danceCtx.moveTo(baseX - 15, headY - 5);
                    danceCtx.quadraticCurveTo(baseX - 30, headY - 20, baseX - 25, headY - 30); 
                    danceCtx.quadraticCurveTo(baseX - 20, headY - 15, baseX - 15, headY - 5); 
                    danceCtx.closePath();
                    danceCtx.fill();
                    danceCtx.stroke();
                    danceCtx.beginPath();
                    danceCtx.moveTo(baseX + 15, headY - 5);
                    danceCtx.quadraticCurveTo(baseX + 30, headY - 20, baseX + 25, headY - 30);
                    danceCtx.quadraticCurveTo(baseX + 20, headY - 15, baseX + 15, headY - 5);
                    danceCtx.closePath();
                    danceCtx.fill();
                    danceCtx.stroke();
                   break;
                case "witch-hat": 
                    danceCtx.fillStyle = 'black';
                    danceCtx.strokeStyle = '#333';
                    danceCtx.beginPath();
                    danceCtx.ellipse(baseX, headY + 5, 25, 6, 0, 0, Math.PI * 2);
                    danceCtx.fill();
                    danceCtx.stroke();
                    danceCtx.beginPath();
                    danceCtx.moveTo(baseX - 15, headY + 5); 
                    danceCtx.lineTo(baseX + 5, headY - 35); 
                    danceCtx.lineTo(baseX + 15, headY + 5);
                    danceCtx.closePath();
                    danceCtx.fill();
                    danceCtx.stroke();
                   break;
                default:
                    break;
            }
            // Restaurar colores/grosor por si acaso
            danceCtx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent-primary');
            danceCtx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent-primary-hover');
            danceCtx.lineWidth = 2;
        }
    }


    function danceLoop(timestamp) {
        if (!lastTime) lastTime = timestamp;
        drawRhythmicStickFigure(timestamp); 
        lastTime = timestamp;
        animationFrameId = requestAnimationFrame(danceLoop);
    }
    
    // --- CALENDAR LOGIC ---
    function loadCalendar() {
        const dt = new Date();
        if (nav !== 0) dt.setMonth(new Date().getMonth() + nav, 1); 
        const month = dt.getMonth(), year = dt.getFullYear();
        
        const banner = document.getElementById('special-theme-banner');
        if (monthlyThemes[month]) {
            banner.textContent = monthlyThemes[month].name;
            banner.style.display = 'block';
        } else {
            banner.style.display = 'none';
        }

        const firstDayOfMonth = new Date(year, month, 1);
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const paddingDays = (firstDayOfMonth.getDay() + 6) % 7; 

        const monthName = dt.toLocaleDateString('es-ES', { month: 'long' });
        const yearText = ` ${year}`;
        monthDisplay.innerHTML = ''; 
        monthName.split('').forEach(letter => {
            const span = document.createElement('span');
            span.classList.add('animated-letter');
            span.textContent = letter;
            monthDisplay.appendChild(span);
        });
        const yearSpan = document.createElement('span');
        yearSpan.textContent = yearText;
        monthDisplay.appendChild(yearSpan);


        calendar.innerHTML = ''; 
        const notes = JSON.parse(localStorage.getItem('musical-calendar-notes') || '{}');

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        for (let i = 1; i <= paddingDays + daysInMonth; i++) {
            const daySquare = document.createElement('div');
            // Se elimina 'flex items-center justify-center' para dar paso al innerHTML personalizado
            daySquare.classList.add('calendar-day', 'h-16', 'sm:h-20', 'lg:h-24', 'text-lg', 'rounded-lg', 'transition-all', 'duration-200');
            daySquare.style.padding = '0'; 
            
            if (i > paddingDays) {
                const dayOfMonth = i - paddingDays;
                
                const dayDate = new Date(year, month, dayOfMonth);
                
                const dayString = `${year}-${String(month + 1).padStart(2, '0')}-${String(dayOfMonth).padStart(2, '0')}`;
                daySquare.dataset.date = dayString;

                if (dayDate > today) {
                    // --- D√çA FUTURO (BLOQUEADO) ---
                    daySquare.classList.add('opacity-50', 'cursor-not-allowed', 'flex', 'items-center', 'justify-center');
                    daySquare.innerText = dayOfMonth; 
                
                } else {
                    // --- D√çA ACTUAL O PASADO (HABILITADO) ---
                    daySquare.classList.add('cursor-pointer'); 
                    
                    // Comprobar si es el d√≠a actual
                    if (dayDate.getTime() === today.getTime()) {
                        daySquare.classList.add('current-day');
                    }

                    // --- HTML DEL D√çA (N√∫mero + Bot√≥n MP3) ---
                    daySquare.innerHTML = `
                        <div class="relative w-full h-full flex flex-col items-center justify-between p-1.5 sm:p-2">
                            <span class="text-lg sm:text-xl font-bold themed-text-primary">${dayOfMonth}</span>
                            <button type="button" 
                                    class="mp3-day-button p-1 rounded-full text-xs text-gray-900 bg-amber-400 hover:bg-green-600 transition-colors z-10 shadow-md"
                                    title="Cargar y reproducir MP3 local"
                                    data-day-target="${dayString}"
                                    onclick="event.stopPropagation(); document.getElementById('mp3-file-input').dataset.targetDay='${dayString}'; document.getElementById('mp3-file-input').click();">
                                <i class="fa-solid fa-file-audio"></i>
                            </button>
                        </div>
                    `;

                    // --- A√±adir indicador si hay nota ---
                    if (notes[dayString] && notes[dayString].trim() !== '') {
                        const indicator = document.createElement('div');
                        indicator.classList.add('note-indicator');
                        daySquare.appendChild(indicator);
                    }
                    // --- Fin indicador ---

                    // A√±adir click listener (para abrir modal si no se puls√≥ el bot√≥n)
                    daySquare.addEventListener('click', (e) => {
                        // Solo abre el modal si el elemento clickeado NO es el bot√≥n mp3
                        if (!e.target.closest('.mp3-day-button')) {
                            openDayModal(daySquare, dayString);
                        }
                    });
                }

            } else {
                daySquare.classList.add('themed-bg-padding', 'opacity-50', 'flex', 'items-center', 'justify-center'); 
            }
            calendar.appendChild(daySquare);
        }
    }
    
    // --- MODAL & EVENT HANDLING (Sin Cambios significativos en initButtons) ---
    function initButtons() {
        document.getElementById('nextButton').addEventListener('click', () => { nav++; loadCalendar(); });
        document.getElementById('backButton').addEventListener('click', () => { nav--; loadCalendar(); });
        saveNoteButton.addEventListener('click', saveNote);
        document.getElementById('playlist-button').addEventListener('click', playMonthPlaylist);

        mp3FileInput.addEventListener('change', handleLocalMp3Upload);


        // Modals
        const statsModal = document.getElementById('stats-modal');
        document.getElementById('stats-button').addEventListener('click', showStats);
        document.getElementById('close-stats-modal').addEventListener('click', () => statsModal.classList.add('hidden'));
        statsModal.addEventListener('click', (e) => { if (e.target === statsModal) statsModal.classList.add('hidden'); });
        
        const achievementsModal = document.getElementById('achievements-modal');
        document.getElementById('achievements-button').addEventListener('click', showAchievements);
        document.getElementById('close-achievements-modal').addEventListener('click', () => achievementsModal.classList.add('hidden'));
        achievementsModal.addEventListener('click', (e) => { if (e.target === achievementsModal) achievementsModal.classList.add('hidden'); });

        const wardrobeModal = document.getElementById('wardrobe-modal');
        document.getElementById('wardrobe-button').addEventListener('click', showWardrobe);
        document.getElementById('close-wardrobe-modal').addEventListener('click', () => wardrobeModal.classList.add('hidden'));
        wardrobeModal.addEventListener('click', (e) => { if (e.target === wardrobeModal) wardrobeModal.classList.add('hidden'); });
        document.getElementById('clear-selected-item').addEventListener('click', () => {
            selectWardrobeItem('none'); 
            updateWardrobeUI(); 
        });


        document.getElementById('close-day-modal').addEventListener('click', () => {
            dayModal.classList.add('hidden');
            selectedDate = null; 
            if(animationFrameId) cancelAnimationFrame(animationFrameId);
            danceLoop(performance.now());
        });
        
        dayModal.addEventListener('click', (e) => { 
            if (e.target === dayModal) {
                dayModal.classList.add('hidden');
                selectedDate = null; 
                if(animationFrameId) cancelAnimationFrame(animationFrameId);
                danceLoop(performance.now());
            }
        });
        // --- FIN DE LA CORRECCI√ìN ---

        // Player & Animation
        audioPlayer.addEventListener('play', () => {
            globalPlayerContainer.classList.remove('hidden');
            cancelAnimationFrame(animationFrameId); 
            lastTime = 0; 
            animationFrameId = requestAnimationFrame(danceLoop);
        });
        audioPlayer.addEventListener('pause', () => {
            cancelAnimationFrame(animationFrameId);
        });
        
        // MODIFICADO: Mover l√≥gica de desbloqueo aqu√≠
        audioPlayer.addEventListener('ended', async () => {
            cancelAnimationFrame(animationFrameId);
            
            // --- L√ìGICA DE DESBLOQUEO AL TERMINAR ---
            const mp3Cache = JSON.parse(localStorage.getItem('local-mp3-cache') || '{}');
            const isCurrentlyPlayingLocal = selectedDate && mp3Cache[selectedDate];

            // Solo desbloquear si es una canci√≥n DEL CALENDARIO
            if (selectedDate && !isCurrentlyPlayingLocal) { 
                const dayOfMonth = new Date(selectedDate).getDate(); 
                const itemForThisDay = dailyItems[dayOfMonth]; 
                if (itemForThisDay && !unlockedItems.includes(itemForThisDay.id)) {
                    await unlockItem(itemForThisDay.id);
                    if (!dayModal.classList.contains('hidden')) {
                        itemUnlockMessage.classList.remove('hidden');
                        setTimeout(() => itemUnlockMessage.classList.add('hidden'), 5000);
                    }
                }
            }
            // --- FIN L√ìGICA DE DESBLOQUEO ---
            
            playNextInPlaylist(); 
        });

        document.getElementById('theme-switcher').addEventListener('change', (e) => { applyTheme(e.target.value); saveTheme(e.target.value); });
        
        // Speed controls
        document.querySelectorAll('.speed-control-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const speed = parseFloat(btn.dataset.speed);
                audioPlayer.playbackRate = speed;
                // Actualizar clase activa
                document.querySelectorAll('.speed-control-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            });
        });
    }

    // NUEVA FUNCI√ìN: Manejar subida de MP3 local
    async function handleLocalMp3Upload(event) {
        const file = event.target.files[0];
        // La fecha objetivo (el d√≠a en el que se pulsa el bot√≥n) est√° en el dataset del input oculto
        const targetDay = event.target.dataset.targetDay; 
        if (!file || !targetDay) return;

        // 1. Revocar el URL anterior para este d√≠a (si existe).
        revokeLocalMp3ForDay(targetDay);
        
        // 2. Crear un nuevo URL de objeto para el archivo local
        const newObjectURL = URL.createObjectURL(file);
        
        // 3. Crear el objeto de canci√≥n local para guardar
        const localSong = {
            title: file.name.replace(/\.[^/.]+$/, "") || 'Canci√≥n Local', // Quitar extensi√≥n
            artist: 'Archivo Local',
            clue: 'Tu canci√≥n personalizada.',
            src: newObjectURL
        };
        
        // 4. Guardar en cach√© y establecer la fecha seleccionada
        const mp3Cache = JSON.parse(localStorage.getItem('local-mp3-cache') || '{}');
        mp3Cache[targetDay] = localSong;
        localStorage.setItem('local-mp3-cache', JSON.stringify(mp3Cache));
        
        // --- Set UI context (importante para la reproducci√≥n y modal logic) ---
        selectedDate = targetDay; // Establece el contexto del d√≠a
        currentPlaylist = []; // Cancelar cualquier playlist en curso

        // 5. Reproducir y actualizar UI del reproductor flotante
        // Pasamos true para isLocalSong para que no intente registrar historial/logros
        await playSong(localSong, true, true); 
        
        // 6. Si el modal est√° abierto para este d√≠a, actualizar su contenido
        const dayElement = calendar.querySelector(`.calendar-day[data-date="${targetDay}"]`);
        if (!dayModal.classList.contains('hidden') && dayElement && dayElement.classList.contains('selected-day')) {
            // El modal est√° abierto y es para el d√≠a que acabamos de actualizar.
            songClue.style.display = 'none';
            songTitle.style.display = 'block';
            songTitle.textContent = localSong.title;
            songArtist.textContent = localSong.artist;
            itemUnlockMessage.classList.add('hidden');
        } else {
             // Si el modal no est√° abierto o es para otro d√≠a, solo mostramos el toast.
             showAchievementToast({
                id: 'local_upload',
                name: 'M√∫sica Cargada',
                description: `Reproduciendo: ${localSong.title.substring(0, 20)}...`,
                icon: 'fa-solid fa-file-audio'
            });
        }
        
        // 7. Limpiar el input
        event.target.value = null;
    }


    async function openDayModal(dayElement, dateString, autoplay = true) {
        selectedDate = dateString; 
        document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected-day'));
        if (dayElement) dayElement.classList.add('selected-day');

        const [year, monthNum, day] = dateString.split('-').map(Number);
        const monthIndex = monthNum - 1; 

        // --- REVISAR CACH√â MP3 LOCAL ---
        const mp3Cache = JSON.parse(localStorage.getItem('local-mp3-cache') || '{}');
        const localSong = mp3Cache[dateString];

        let song;
        let isLocal = false; // Bandera para saber qu√© tipo de canci√≥n es

        if (localSong) {
             // 1. Usar la canci√≥n local guardada
             song = localSong;
             isLocal = true;
             
             // Mostrar detalles inmediatamente (sin pista/clue)
             songClue.style.display = 'none';
             songTitle.style.display = 'block';
             songTitle.textContent = song.title;
             songArtist.textContent = song.artist;
             itemUnlockMessage.classList.add('hidden');
        } else {
            // 2. Usar la canci√≥n del calendario (comportamiento est√°ndar)
            const currentSongs = monthlyThemes[monthIndex]?.songs || defaultSongs;
            const songIndex = day - 1; 

            if (songIndex < 0 || songIndex >= currentSongs.length) {
                 // Manejar el caso de no haber canci√≥n
                 songClue.textContent = 'No hay canci√≥n para este d√≠a.';
                 songTitle.textContent = '-';
                 songArtist.textContent = '';
                 song = null;
            } else {
                 song = currentSongs[songIndex];
                 
                 // L√≥gica de pista/revelaci√≥n
                 songClue.textContent = `Pista: ${song.clue || '???'}`;
                 songTitle.textContent = 'Adivina la canci√≥n...';
                 songArtist.textContent = '';
                 songClue.style.display = 'block';
                 songTitle.style.display = 'none';
                 itemUnlockMessage.classList.add('hidden'); 

                 setTimeout(() => {
                     songClue.style.display = 'none';
                     songTitle.style.display = 'block';
                     songTitle.textContent = song.title;
                     songArtist.textContent = song.artist;
                 }, 2000); 
            }
        }
        
        if (song) {
            // Pasamos la bandera 'isLocal' a playSong para que sepa si grabar historial
            await playSong(song, autoplay, isLocal); 
        } else {
             audioPlayer.src = '';
        }
             
        await loadNote();
        
        // Actualizar fecha en el √°rea de notas
        const friendlyDate = new Date(year, monthIndex, day).toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
        noteDate.innerText = `Notas para el ${friendlyDate}.`;
        
        dayModal.classList.remove('hidden');
    }

    // MODIFICADO: A√±adido isLocalSong para controlar el registro de historial
    async function playSong(song, autoplay = true, isLocalSong = false) { 

        if (song && song.src) {
            audioPlayer.src = song.src;
            // Resetear velocidad a 1x por defecto al cambiar de canci√≥n
             audioPlayer.playbackRate = 1;
             document.querySelectorAll('.speed-control-btn').forEach(b => b.classList.remove('active'));
             document.querySelector('.speed-control-btn[data-speed="1"]').classList.add('active');

            if (autoplay) {
                try {
                    await audioPlayer.play();
                    
                    // Solo registrar y comprobar logros si NO es una canci√≥n local
                    if (!isLocalSong) {
                        await recordListenHistoryAndCheckAchievements();
                    }
                } catch (error) {
                    // Ignorar errores 'AbortError' que ocurren si el usuario cambia de canci√≥n r√°pidamente
                    if (error.name !== 'AbortError') {
                         console.error(`Error al intentar reproducir autom√°ticamente: ${error.message}. URL: ${song.src}`);
                    }
                }
            }
        } else {
            console.warn("Intento de reproducir canci√≥n inv√°lida:", song);
            audioPlayer.src = ''; 
        }
    }

    // --- DATA & ACHIEVEMENTS LOGIC (Sin Cambios en la l√≥gica de almacenamiento) ---
     async function saveNote() {
          if (!selectedDate) {
            saveNoteButton.textContent = 'Selecciona un d√≠a primero';
            setTimeout(() => { saveNoteButton.textContent = 'Guardar Nota'; }, 1500);
            return;
          }
          const noteText = noteTextarea.value;
          try {
              const notes = JSON.parse(localStorage.getItem('musical-calendar-notes') || '{}');
              
              if (noteText.trim() === '') {
                  delete notes[selectedDate]; 
              } else {
                  notes[selectedDate] = noteText; 
              }

              localStorage.setItem('musical-calendar-notes', JSON.stringify(notes));
              
              const daySquare = calendar.querySelector(`.calendar-day[data-date="${selectedDate}"]`);
              if (daySquare) {
                  const existingIndicator = daySquare.querySelector('.note-indicator');
                  if (noteText.trim() !== '') {
                      if (!existingIndicator) {
                          const indicator = document.createElement('div');
                          indicator.classList.add('note-indicator');
                          daySquare.appendChild(indicator);
                      }
                  } else {
                      if (existingIndicator) {
                          existingIndicator.remove();
                      }
                  }
              }

              saveNoteButton.textContent = '¬°Guardado!';
              saveNoteButton.disabled = true;
              setTimeout(() => {
                  saveNoteButton.textContent = 'Guardar Nota';
                  saveNoteButton.disabled = false;
              }, 1500);
          } catch (error) {
              console.error("Error guardando la nota en localStorage:", error);
              saveNoteButton.textContent = 'Error al guardar';
          }
     }

     async function loadNote() {
          if (!selectedDate) { 
              noteTextarea.value = ''; 
              return;
          }
          try {
              const notes = JSON.parse(localStorage.getItem('musical-calendar-notes') || '{}');
              noteTextarea.value = notes[selectedDate] || '';
          } catch (error) {
              console.error("Error cargando la nota desde localStorage:", error);
              noteTextarea.value = ''; 
          }
     }

     async function showStats() {
          const statsContent = document.getElementById('stats-content');
          statsContent.innerHTML = '<p>Cargando estad√≠sticas...</p>'; 

          try {
              const listenedDates = JSON.parse(localStorage.getItem('musical-calendar-history') || '[]');

              if (listenedDates.length === 0) {
                  statsContent.innerHTML = '<p>A√∫n no has escuchado ninguna canci√≥n este mes.</p>';
                  document.getElementById('stats-modal').classList.remove('hidden');
                  return;
              }

              const currentVisibleDate = new Date();
              if (nav !== 0) currentVisibleDate.setMonth(new Date().getMonth() + nav, 1);
              const currentMonth = currentVisibleDate.getMonth();
              const currentYear = currentVisibleDate.getFullYear();

              const datesThisMonth = listenedDates.filter(d => {
                  const date = new Date(d);
                  try {
                      return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
                  } catch (e) { 
                      console.warn("Fecha inv√°lida en el historial:", d, e);
                      return false; 
                  }
              });

              const daysListened = datesThisMonth.length;
              const totalDaysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
              const percentage = totalDaysInMonth > 0 ? ((daysListened / totalDaysInMonth) * 100).toFixed(1) : 0;

              let currentStreak = 0;
              if (datesThisMonth.length > 0) {
                  datesThisMonth.sort((a, b) => new Date(b) - new Date(a));
                  let lastDate = new Date(datesThisMonth[0]);
                  currentStreak = 1;
                  for (let i = 1; i < datesThisMonth.length; i++) {
                      const currentDate = new Date(datesThisMonth[i]);
                      const diffTime = lastDate - currentDate;
                      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                      if (diffDays === 1) {
                          currentStreak++;
                          lastDate = currentDate;
                      } else {
                          break; 
                      }
                  }
              }

              statsContent.innerHTML = `
                   <div class="space-y-3">
                       <p><strong class="themed-text-accent">Mes:</strong> ${currentVisibleDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' })}</p>
                       <p><strong class="themed-text-accent">D√≠as escuchados:</strong> ${daysListened} de ${totalDaysInMonth}</p>
                       <p><strong class="themed-text-accent">Porcentaje del mes:</strong> ${percentage}%</p>
                       <p><strong class="themed-text-accent">Racha actual (en este mes):</strong> ${currentStreak} d√≠as</p>
                   </div>
               `;

          } catch (error) {
              console.error("Error al cargar estad√≠sticas desde localStorage:", error);
              statsContent.innerHTML = '<p class="text-red-400">Error al cargar estad√≠sticas.</p>';
          }

          document.getElementById('stats-modal').classList.remove('hidden');
     }


     async function recordListenHistoryAndCheckAchievements() {
          if (!selectedDate) return; 
          
          try {
              // 1. Registrar la escucha en localStorage
              let listenedDates = JSON.parse(localStorage.getItem('musical-calendar-history') || '[]');
              if (!listenedDates.includes(selectedDate)) {
                  listenedDates.push(selectedDate);
                  localStorage.setItem('musical-calendar-history', JSON.stringify(listenedDates));
              }
            
              // 2. Obtener logros desbloqueados de localStorage
              let unlockedAchievements = JSON.parse(localStorage.getItem('musical-calendar-achievements') || '[]');

              // 3. Funci√≥n auxiliar para desbloquear (ahora guarda en localStorage)
              const checkAndUnlock = async (achId) => {
                  if (!unlockedAchievements.includes(achId) && achievements[achId]) { 
                      showAchievementToast(achievements[achId]);
                      unlockedAchievements.push(achId); 
                      localStorage.setItem('musical-calendar-achievements', JSON.stringify(unlockedAchievements));

                      const badge = document.getElementById('achievements-badge');
                      if (badge) {
                          badge.classList.remove('hidden');
                      }
                  }
              };

              // 4. Comprobar logros espec√≠ficos 
              
              // Racha de 7 d√≠as
              let consecutiveDays7 = 0;
              const today = new Date(selectedDate); 
              for (let i = 0; i < 7; i++) {
                  const d = new Date(today);
                  d.setDate(today.getDate() - i);
                  const dateStrToFind = d.toISOString().split('T')[0];
                  if (listenedDates.includes(dateStrToFind)) {
                      consecutiveDays7++;
                  } else {
                      break; 
                  }
              }
              if (consecutiveDays7 >= 7) await checkAndUnlock('WEEK_STREAK');

              // Racha de 30 d√≠as
              let consecutiveDays30 = 0;
              for (let i = 0; i < 30; i++) {
                  const d = new Date(today);
                  d.setDate(today.getDate() - i);
                  const dateStrToFind = d.toISOString().split('T')[0];
                  if (listenedDates.includes(dateStrToFind)) {
                      consecutiveDays30++;
                  } else {
                      break;
                  }
              }
              if (consecutiveDays30 >= 30) await checkAndUnlock('MONTH_STREAK');


              // Completar Rocktubre
              const currentMonth = today.getMonth(); 
              if (currentMonth === 9 && monthlyThemes[9]) { 
                  const rocktoberSongs = monthlyThemes[9].songs;
                  const requiredRocktoberDates = rocktoberSongs.map((_, index) => {
                      const day = index + 1;
                      return `${today.getFullYear()}-10-${String(day).padStart(2, '0')}`;
                  });
                  const allRocktoberListened = requiredRocktoberDates.every(reqDate => listenedDates.includes(reqDate));
                  if (allRocktoberListened) {
                      await checkAndUnlock('ROCKTOBER_COMPLETE');
                  }
              }

          } catch (error) {
              console.error("Error al registrar historial o comprobar logros en localStorage:", error);
          }
     }


     async function showAchievements() {
          const content = document.getElementById('achievements-content');
          content.innerHTML = '<p>Cargando logros...</p>'; 

          const badge = document.getElementById('achievements-badge');
          if (badge) {
              badge.classList.add('hidden');
          }

          try {
              const unlockedIds = JSON.parse(localStorage.getItem('musical-calendar-achievements') || '[]');
            
              content.innerHTML = ''; 

              if (Object.keys(achievements).length === 0) {
                  content.innerHTML = '<p>No hay logros definidos.</p>';
              } else {
                  for (const ach of Object.values(achievements)) {
                      const isUnlocked = unlockedIds.includes(ach.id);
                      const card = document.createElement('div');
                      card.className = `p-4 rounded-lg flex items-center gap-4 transition-all ${isUnlocked ? 'themed-bg-tertiary shadow-lg ring-2 ring-amber-400' : 'themed-bg-padding opacity-60'}`; 
                      card.innerHTML = `
                          <i class="${ach.icon || 'fa-solid fa-question'} fa-2x ${isUnlocked ? 'themed-text-accent' : 'text-gray-500'}"></i>
                          <div>
                              <h3 class="font-bold ${isUnlocked ? 'themed-text-primary' : 'text-gray-400'}">${ach.name}</h3>
                              <p class="text-sm ${isUnlocked ? 'themed-text-secondary' : 'text-gray-500'}">${ach.description}</p>
                          </div>
                      `;
                      content.appendChild(card);
                  }
              }
          } catch (error) {
              console.error("Error al mostrar logros desde localStorage:", error);
              content.innerHTML = '<p class="text-red-400">Error al cargar los logros.</p>';
          }

          document.getElementById('achievements-modal').classList.remove('hidden');
     }

    function showAchievementToast(achievement) {
          const toastContainer = document.getElementById('toast-container');
          if (toastContainer.querySelector(`[data-ach-id="${achievement.id}"]`)) return;

          const toast = document.createElement('div');
          toast.dataset.achId = achievement.id;  
          toast.className = 'slide-in-up themed-bg-secondary p-4 rounded-lg shadow-2xl flex items-center gap-3 mb-2';
          toast.innerHTML = `
              <i class="${achievement.icon || 'fa-solid fa-medal'} fa-2x themed-text-accent"></i>
              <div>
                  <p class="font-bold">¬°Notificaci√≥n!</p>
                  <p class="text-sm">${achievement.name}</p>
              </div>
          `;
          toastContainer.appendChild(toast);
          setTimeout(() => {
              toast.style.transition = 'opacity 0.5s ease-out, transform 0.5s ease-out';
              toast.style.opacity = '0';
              toast.style.transform = 'translateY(20px)';
              setTimeout(() => toast.remove(), 500);  
          }, 5000);
    }


    // --- MONIGOTE CUSTOMIZATION LOGIC (Sin Cambios) ---
    async function loadUnlockedItems() {
          try {
              const wardrobe = JSON.parse(localStorage.getItem('musical-calendar-wardrobe') || '{}');
              unlockedItems = wardrobe.unlockedIds || [];
              selectedItem = wardrobe.selectedItem || "none";
          } catch (error) {
              console.error("Error cargando objetos del armario desde localStorage:", error);
              unlockedItems = []; 
              selectedItem = "none";
          }
    }

    async function unlockItem(itemId) {
          if (!itemId || unlockedItems.includes(itemId)) return; 

          unlockedItems.push(itemId); 
          
          try {
              const wardrobe = JSON.parse(localStorage.getItem('musical-calendar-wardrobe') || '{}');
              if (!wardrobe.unlockedIds) wardrobe.unlockedIds = [];
              if (!wardrobe.unlockedIds.includes(itemId)) {
                  wardrobe.unlockedIds.push(itemId);
              }
              localStorage.setItem('musical-calendar-wardrobe', JSON.stringify(wardrobe));

              const itemData = Object.values(dailyItems).find(item => item.id === itemId);
              const itemName = itemData?.name || itemId;
              const itemIcon = itemData?.icon || 'fa-solid fa-sparkles';
              showAchievementToast({ id: `item-${itemId}`, name: `¬°Objeto: ${itemName}!`, icon: itemIcon }); 
              
              if(animationFrameId) cancelAnimationFrame(animationFrameId); 
              danceLoop(performance.now());
          } catch (error) {
              console.error(`Error al desbloquear el objeto ${itemId} en localStorage:`, error);
          }
    }


    async function selectWardrobeItem(itemId) {
          if (itemId !== "none" && !unlockedItems.includes(itemId)) {
              console.warn("Intento de seleccionar un objeto no desbloqueado:", itemId);
              return; 
          }

          selectedItem = itemId; 

          try {
              const wardrobeToSave = {
                  unlockedIds: unlockedItems, 
                  selectedItem: selectedItem 
              };
              localStorage.setItem('musical-calendar-wardrobe', JSON.stringify(wardrobeToSave));
              
              if(animationFrameId) cancelAnimationFrame(animationFrameId);
              danceLoop(performance.now());
          } catch (error) {
              console.error(`Error al seleccionar el objeto ${itemId} en localStorage:`, error);
          }
    }


    async function showWardrobe() {
          await loadUnlockedItems();

          const wardrobeItemsContainer = document.getElementById('wardrobe-items');
          wardrobeItemsContainer.innerHTML = ''; 

          const createItemCard = (item, isNoneOption = false) => {
              const card = document.createElement('div');
              const isUnlocked = isNoneOption || unlockedItems.includes(item.id);
              const isSelected = selectedItem === item.id;

              card.className = `themed-bg-tertiary rounded-lg p-4 text-center item-card 
                  ${isUnlocked ? '' : 'disabled'} 
                  ${isSelected ? 'selected' : ''}`;
              card.dataset.itemId = item.id;
              
              card.innerHTML = `
                  <i class="${item.icon || 'fa-solid fa-question'} fa-3x ${isUnlocked ? (isSelected ? 'themed-text-accent' : 'themed-text-primary') : 'text-gray-500'} mb-2"></i>
                  <p class="text-sm font-semibold ${isUnlocked ? 'themed-text-primary' : 'text-gray-500'}">${item.name}</p>
              `;

              if (isUnlocked) {
                  card.addEventListener('click', () => {
                      selectWardrobeItem(item.id); 
                      updateWardrobeUI(); 
                  });
              }
              return card;
          };

          const noneItem = { id: "none", name: "Ninguno", icon: "fa-solid fa-circle-xmark" };
          wardrobeItemsContainer.appendChild(createItemCard(noneItem, true));
    
           const addedItemIds = new Set(["none"]); 
           Object.values(dailyItems).forEach(item => {
               if (!addedItemIds.has(item.id)) {
                   wardrobeItemsContainer.appendChild(createItemCard(item));
                   addedItemIds.add(item.id);
               }
           });

          updateWardrobeUI(); 
          document.getElementById('wardrobe-modal').classList.remove('hidden');
    }

     function updateWardrobeUI() {
          document.querySelectorAll('#wardrobe-items .item-card').forEach(card => {
              card.classList.remove('selected');
              const icon = card.querySelector('i');
              if (card.dataset.itemId === selectedItem) {
                  card.classList.add('selected');
                  if (icon) icon.classList.add('themed-text-accent');
              } else {
                  if (icon) icon.classList.remove('themed-text-accent'); 
              }
          });
          document.getElementById('clear-selected-item').classList.toggle('hidden', selectedItem === 'none');
     }


    // --- PLAYLIST & OTHER FUNCTIONS (Sin Cambios) ---
     function playMonthPlaylist() {
          const currentVisibleDate = new Date();
          if (nav !== 0) currentVisibleDate.setMonth(new Date().getMonth() + nav, 1);
          const monthIndex = currentVisibleDate.getMonth();

          currentPlaylist = monthlyThemes[monthIndex]?.songs || defaultSongs;
          
          if (currentPlaylist.length > 0) {
              currentPlaylistIndex = 0; 
              playNextInPlaylist(true); 
          } else {
              console.warn("No hay canciones para la playlist de este mes.");
          }
     }

     function playNextInPlaylist(isFirstSong = false) {
          if (!isFirstSong) {
              currentPlaylistIndex++;
          }

          if (currentPlaylistIndex >= currentPlaylist.length) {
              console.log("Playlist terminada.");
              globalPlayerContainer.classList.add('hidden'); 
              currentPlaylist = []; 
              return; 
          }

          const nextSong = currentPlaylist[currentPlaylistIndex];
          const dateForSong = new Date(); 
          if (nav !== 0) dateForSong.setMonth(new Date().getMonth() + nav, 1);
          dateForSong.setDate(currentPlaylistIndex + 1); 
          selectedDate = dateForSong.toISOString().split('T')[0]; 
          
          // No mostramos pista/clue durante la playlist
          songClue.style.display = 'none';
          songTitle.style.display = 'block';
          songTitle.textContent = nextSong.title;
          songArtist.textContent = nextSong.artist;
          itemUnlockMessage.classList.add('hidden'); 
          loadNote(); 
          
          // La playlist solo usa canciones predeterminadas, por lo que isLocalSong es false
          playSong(nextSong, true, false); 
          globalPlayerContainer.classList.remove('hidden'); 
     }
    
    // --- APP INITIALIZATION (Sin Cambios) ---
    async function startApp() {
        const savedTheme = localStorage.getItem('musical-calendar-theme') || 'basico';
        applyTheme(savedTheme);

        try {
            console.log("Iniciando la aplicaci√≥n con localStorage.");
            
            await loadUnlockedItems(); 
            
            initButtons(); 
            
            loadCalendar(); 
            
            if(animationFrameId) cancelAnimationFrame(animationFrameId);
            danceLoop(performance.now());

        } catch (error) {
            console.error("Error cr√≠tico inicializando la aplicaci√≥n:", error);
            document.body.innerHTML = `<div class="text-red-400 text-center p-8">
                 <h2>Error al Cargar</h2>
                 <p>No se pudo inicializar la aplicaci√≥n.</p>
                 <p class="text-xs mt-2">Detalle: ${error.message}</p>
                 </div>`;
        }
    }
    
    // Listener para limpiar URL del objeto al cerrar la p√°gina
    window.addEventListener('beforeunload', () => {
        const mp3Cache = JSON.parse(localStorage.getItem('local-mp3-cache') || '{}');
        Object.values(mp3Cache).forEach(song => {
             if (song.src.startsWith('blob:')) {
                 URL.revokeObjectURL(song.src);
             }
        });
        // console.log("[Cleanup] All local blob URLs revoked on closing.");
    }); 

    // --- Iniciar la aplicaci√≥n despu√©s de que el DOM est√© completamente cargado ---
    window.addEventListener('DOMContentLoaded', startApp);

    // Event listener para cerrar modales con la tecla Escape (sin cambios)
    window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            document.getElementById('stats-modal').classList.add('hidden');
            document.getElementById('day-modal').classList.add('hidden');
            document.getElementById('achievements-modal').classList.add('hidden');
            document.getElementById('wardrobe-modal').classList.add('hidden');
        }
    });
</script>

</body>
</html>
